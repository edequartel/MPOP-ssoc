<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>mPOP SSoC Editor (Supabase)</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root { --bg:#0b0e14; --fg:#e9effa; --muted:#a9b6c8; --card:#121826; --line:rgba(255,255,255,.12); }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--fg); margin:16px; }
    h1 { font-size:20px; margin:0 0 10px; }
    .row { display:grid; grid-template-columns: 360px 1fr; gap:12px; align-items:start; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .muted { color:var(--muted); font-size:13px; line-height:1.4; }
    label { display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }
    input, textarea, select, button {
      width:100%;
      box-sizing:border-box;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--fg);
      padding:10px;
      font-size:14px;
    }
    textarea { min-height:80px; resize:vertical; }
    button { cursor:pointer; background: rgba(255,255,255,.08); }
    button:hover { background: rgba(255,255,255,.12); }
    .btnrow { display:flex; gap:8px; flex-wrap:wrap; }
    .btnrow button { width:auto; padding:10px 12px; }
    .list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .itembtn { text-align:left; }
    .split { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; }
    .pill { border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); }
    .ok { color:#b7f7c1; }
    .err { color:#ffb4b4; }
    .hr { height:1px; background:var(--line); margin:10px 0; }
    .tiny { font-size:12px; color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <h1>mPOP SSoC Editor</h1>
  <div class="muted">
    This page reads Supabase URL + anon key from <span class="mono">localStorage</span> (or asks you once).
    It cannot truly “hide” secrets in a browser. Use a server/proxy if you need secrecy.
  </div>

  <div class="hr"></div>

  <div class="row">
    <!-- LEFT -->
    <div class="card">
      <h2 style="margin:0 0 8px; font-size:16px;">Connection</h2>

      <div class="btnrow">
        <button id="btnSetConfig">Set / Change Supabase config</button>
        <button id="btnClearConfig">Clear saved config</button>
      </div>
      <div id="cfgMsg" class="tiny" style="margin-top:10px;"></div>

      <div class="hr"></div>

      <h2 style="margin:0 0 8px; font-size:16px;">Auth</h2>

      <div id="authLoggedOut">
        <label>Email</label>
        <input id="email" type="email" placeholder="name@domain" />

        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" />

        <div class="btnrow" style="margin-top:10px;">
          <button id="btnSignIn">Sign in</button>
          <button id="btnSignUp">Sign up</button>
        </div>
        <div id="authMsg" class="tiny" style="margin-top:10px;"></div>
      </div>

      <div id="authLoggedIn" style="display:none;">
        <div class="kpi">
          <div class="pill">Signed in: <span id="userEmail" class="ok"></span></div>
          <div class="pill">Role: <span id="userRole" class="ok"></span></div>
        </div>
        <div class="btnrow" style="margin-top:10px;">
          <button id="btnRefresh">Refresh list</button>
          <button id="btnSignOut">Sign out</button>
        </div>
        <div id="listMsg" class="tiny" style="margin-top:10px;"></div>

        <div class="hr"></div>

        <h2 style="margin:0 0 8px; font-size:16px;">mPOP items</h2>
        <label>Search</label>
        <input id="search" placeholder="type code/title (e.g., bal-001)" />
        <div class="list" id="itemsList"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2 style="margin:0 0 8px; font-size:16px;">Editor</h2>
      <div id="editorHint" class="muted">Sign in and select an item to edit.</div>

      <div id="editor" style="display:none;">
        <div class="kpi">
          <div class="pill">Code: <span id="code" class="ok mono"></span></div>
          <div class="pill">Status: <span id="status" class="ok mono"></span></div>
          <div class="pill">Version: <span id="version" class="ok mono"></span></div>
          <div class="pill">Updated: <span id="updatedAt" class="ok mono"></span></div>
        </div>

        <div class="btnrow" style="margin-top:10px;">
          <button id="btnExportMd">Export Markdown</button>
          <button id="btnExportPdf">Export PDF</button>
        </div>
        <div id="exportMsg" class="tiny" style="margin-top:8px;"></div>

        <label>Title</label>
        <input id="title" />

        <label>Status</label>
        <select id="statusSelect">
          <option value="draft">draft</option>
          <option value="in_review">in_review</option>
          <option value="approved">approved</option>
        </select>

        <div class="hr"></div>

        <label>1a verhaal tekst</label>
        <textarea id="story_text"></textarea>

        <label>1b verhaal audio path</label>
        <input id="story_audio_path" />

        <label>2a klankzuiver</label>
        <textarea id="klankzuiver_text"></textarea>

        <label>2a klankzuiver letters</label>
        <input id="klankzuiver_letters" />

        <div class="hr"></div>

        <label>3a opdracht tekst</label>
        <textarea id="opdracht1_text"></textarea>

        <label>3b opdracht audio path</label>
        <input id="opdracht1_audio_path" />

        <label>4a opdracht tekst</label>
        <textarea id="opdracht2_text"></textarea>

        <label>4b opdracht audio path</label>
        <input id="opdracht2_audio_path" />

        <div class="hr"></div>

        <label>6a woord tekst</label>
        <input id="woord_text" />

        <label>6b woord audio path</label>
        <input id="woord_audio_path" />

        <label>7 afbeelding path</label>
        <input id="image1_path" />

        <label>8a beschrijving tekst</label>
        <textarea id="beschrijving_text"></textarea>

        <label>8b beschrijving audio path</label>
        <input id="beschrijving_audio_path" />

        <label>9 geluiden</label>
        <div class="muted tiny">Managed via <span class="mono">mpop_sounds</span> (not shown in this minimal editor).</div>

        <label>10 afbeelding path</label>
        <input id="image2_path" />

        <label>11 tekst</label>
        <textarea id="text11"></textarea>

        <div class="hr"></div>

        <label>12 blz A titel woord letters</label>
        <input id="page_a_title_letters" />
        <label>13 blz A tekst</label>
        <textarea id="page_a_text"></textarea>

        <label>14 blz B titel woord letters</label>
        <input id="page_b_title_letters" />
        <label>15 blz B tekst</label>
        <textarea id="page_b_text"></textarea>

        <label>16 blz C titel woord letters</label>
        <input id="page_c_title_letters" />
        <label>17 blz C tekst</label>
        <textarea id="page_c_text"></textarea>

        <label>18 handleiding</label>
        <textarea id="handleiding_text"></textarea>

        <div class="hr"></div>

        <div class="btnrow">
          <button id="btnSave">Save changes</button>
          <button id="btnReload">Reload item</button>
        </div>
        <div id="saveMsg" class="tiny" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Supabase client + state
    // -----------------------------
    let sb = null;
    let currentItem = null;
    let itemsCache = [];

    const $ = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function msg(el, text, ok=true) {
      el.innerHTML = text ? `<span class="${ok ? 'ok' : 'err'}">${escapeHtml(text)}</span>` : "";
    }

    function getCfg() {
      const url = localStorage.getItem("mpop_sb_url") || "";
      const key = localStorage.getItem("mpop_sb_anon") || "";
      return { url, key };
    }

    function ensureClient() {
      const { url, key } = getCfg();
      if (!url || !key) throw new Error("No Supabase config saved. Click “Set / Change Supabase config”.");
      sb = window.supabase.createClient(url, key);
      return sb;
    }

    async function refreshAuthUI() {
      if (!sb) return;
      const { data: { session } } = await sb.auth.getSession();
      const loggedIn = !!session?.user;

      $("authLoggedOut").style.display = loggedIn ? "none" : "block";
      $("authLoggedIn").style.display  = loggedIn ? "block" : "none";

      if (loggedIn) {
        $("userEmail").textContent = session.user.email || "(no email)";

        const { data: prof, error } = await sb
          .from("profiles")
          .select("role")
          .eq("user_id", session.user.id)
          .maybeSingle();

        $("userRole").textContent = error ? "unknown" : (prof?.role || "unknown");

        await loadItems();
      } else {
        $("itemsList").innerHTML = "";
        hideEditor();
      }
    }

    async function signIn() {
      try {
        ensureClient();
        msg($("authMsg"), "");
        const email = $("email").value.trim();
        const password = $("password").value;
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        msg($("authMsg"), "Signed in.");
        await refreshAuthUI();
      } catch (e) {
        msg($("authMsg"), e.message || String(e), false);
      }
    }

    async function signUp() {
      try {
        ensureClient();
        msg($("authMsg"), "");
        const email = $("email").value.trim();
        const password = $("password").value;
        const { error } = await sb.auth.signUp({ email, password });
        if (error) throw error;
        msg($("authMsg"), "Sign-up OK. If email confirmation is enabled, confirm your email before signing in.");
      } catch (e) {
        msg($("authMsg"), e.message || String(e), false);
      }
    }

    async function signOut() {
      try {
        await sb.auth.signOut();
        await refreshAuthUI();
      } catch (e) {
        msg($("listMsg"), e.message || String(e), false);
      }
    }

    async function loadItems() {
      try {
        msg($("listMsg"), "Loading...");
        const { data, error } = await sb
          .from("mpop_items")
          .select("id, code, title, status, updated_at, version")
          .order("code", { ascending: true });

        if (error) throw error;

        itemsCache = data || [];
        renderItems();
        msg($("listMsg"), `Loaded ${itemsCache.length} items.`);
      } catch (e) {
        msg($("listMsg"), e.message || String(e), false);
      }
    }

    function renderItems() {
      const q = $("search").value.trim().toLowerCase();
      const filtered = !q ? itemsCache : itemsCache.filter(x =>
        (x.code || "").toLowerCase().includes(q) ||
        (x.title || "").toLowerCase().includes(q)
      );

      const host = $("itemsList");
      host.innerHTML = "";

      for (const it of filtered) {
        const b = document.createElement("button");
        b.className = "itembtn";
        b.textContent = `${it.code || "(no code)"} — ${it.title || ""} [${it.status}]`;
        b.onclick = () => selectItem(it.id);
        host.appendChild(b);
      }
    }

    async function selectItem(id) {
      try {
        msg($("saveMsg"), "");
        const { data, error } = await sb.from("mpop_items").select("*").eq("id", id).single();
        if (error) throw error;
        currentItem = data;
        showEditor(data);
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      }
    }

    function hideEditor() {
      $("editorHint").style.display = "block";
      $("editor").style.display = "none";
      currentItem = null;
    }

    function showEditor(row) {
      $("editorHint").style.display = "none";
      $("editor").style.display = "block";

      $("code").textContent = row.code || "";
      $("status").textContent = row.status || "";
      $("version").textContent = String(row.version ?? "");
      $("updatedAt").textContent = row.updated_at || "";

      $("title").value = row.title || "";
      $("statusSelect").value = row.status || "draft";

      $("story_text").value = row.story_text || "";
      $("story_audio_path").value = row.story_audio_path || "";

      $("klankzuiver_text").value = row.klankzuiver_text || "";
      $("klankzuiver_letters").value = row.klankzuiver_letters || "";

      $("opdracht1_text").value = row.opdracht1_text || "";
      $("opdracht1_audio_path").value = row.opdracht1_audio_path || "";

      $("opdracht2_text").value = row.opdracht2_text || "";
      $("opdracht2_audio_path").value = row.opdracht2_audio_path || "";

      $("woord_text").value = row.woord_text || "";
      $("woord_audio_path").value = row.woord_audio_path || "";

      $("image1_path").value = row.image1_path || "";
      $("beschrijving_text").value = row.beschrijving_text || "";
      $("beschrijving_audio_path").value = row.beschrijving_audio_path || "";
      $("image2_path").value = row.image2_path || "";

      $("text11").value = row.text11 || "";

      $("page_a_title_letters").value = row.page_a_title_letters || "";
      $("page_a_text").value = row.page_a_text || "";

      $("page_b_title_letters").value = row.page_b_title_letters || "";
      $("page_b_text").value = row.page_b_text || "";

      $("page_c_title_letters").value = row.page_c_title_letters || "";
      $("page_c_text").value = row.page_c_text || "";

      $("handleiding_text").value = row.handleiding_text || "";

      msg($("exportMsg"), "");
    }

    async function saveItem() {
      if (!currentItem) return;
      try {
        msg($("saveMsg"), "Saving...");
        const payload = {
          title: $("title").value.trim(),
          status: $("statusSelect").value,

          story_text: $("story_text").value,
          story_audio_path: $("story_audio_path").value.trim(),

          klankzuiver_text: $("klankzuiver_text").value,
          klankzuiver_letters: $("klankzuiver_letters").value.trim(),

          opdracht1_text: $("opdracht1_text").value,
          opdracht1_audio_path: $("opdracht1_audio_path").value.trim(),

          opdracht2_text: $("opdracht2_text").value,
          opdracht2_audio_path: $("opdracht2_audio_path").value.trim(),

          woord_text: $("woord_text").value.trim(),
          woord_audio_path: $("woord_audio_path").value.trim(),

          image1_path: $("image1_path").value.trim(),

          beschrijving_text: $("beschrijving_text").value,
          beschrijving_audio_path: $("beschrijving_audio_path").value.trim(),

          image2_path: $("image2_path").value.trim(),

          text11: $("text11").value,

          page_a_title_letters: $("page_a_title_letters").value.trim(),
          page_a_text: $("page_a_text").value,

          page_b_title_letters: $("page_b_title_letters").value.trim(),
          page_b_text: $("page_b_text").value,

          page_c_title_letters: $("page_c_title_letters").value.trim(),
          page_c_text: $("page_c_text").value,

          handleiding_text: $("handleiding_text").value
        };

        const { data, error } = await sb
          .from("mpop_items")
          .update(payload)
          .eq("id", currentItem.id)
          .eq("version", currentItem.version)   // optimistic concurrency
          .select("*")
          .maybeSingle();

        if (error) throw error;
        if (!data) throw new Error("Conflict: item changed by someone else. Click Reload item and retry.");

        currentItem = data;
        showEditor(data);
        msg($("saveMsg"), "Saved.");
        await loadItems();
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      }
    }

    async function reloadItem() {
      if (!currentItem) return;
      await selectItem(currentItem.id);
      msg($("saveMsg"), "Reloaded.");
    }

    // -----------------------------
    // Export: Markdown + PDF
    // -----------------------------
    function buildMarkdownFromCurrent() {
      if (!currentItem) throw new Error("No item selected.");

      const md = [];
      const h = (t) => md.push(`## ${t}\n`);
      const f = (label, val) => md.push(`**${label}:** ${val ? val : ""}\n`);
      const b = (label, val) => md.push(`### ${label}\n\n${val ? val : ""}\n`);

      md.push(`# mPOP – ${currentItem.code || ""}\n\n`);
      f("Title", currentItem.title);
      f("Status", currentItem.status);
      f("Version", currentItem.version);
      f("Updated", currentItem.updated_at);
      md.push("\n---\n\n");

      b("1a verhaal tekst", currentItem.story_text);
      f("1b verhaal audio path", currentItem.story_audio_path);

      b("2a klankzuiver", currentItem.klankzuiver_text);
      f("2a klankzuiver letters", currentItem.klankzuiver_letters);

      b("3a opdracht tekst", currentItem.opdracht1_text);
      f("3b opdracht audio path", currentItem.opdracht1_audio_path);

      b("4a opdracht tekst", currentItem.opdracht2_text);
      f("4b opdracht audio path", currentItem.opdracht2_audio_path);

      f("6a woord tekst", currentItem.woord_text);
      f("6b woord audio path", currentItem.woord_audio_path);

      f("7 afbeelding path", currentItem.image1_path);

      b("8a beschrijving tekst", currentItem.beschrijving_text);
      f("8b beschrijving audio path", currentItem.beschrijving_audio_path);

      md.push("\n### 9 geluiden\n\nSee `mpop_sounds` table.\n\n");

      f("10 afbeelding path", currentItem.image2_path);
      b("11 tekst", currentItem.text11);

      f("12 blz A titel woord letters", currentItem.page_a_title_letters);
      b("13 blz A tekst", currentItem.page_a_text);

      f("14 blz B titel woord letters", currentItem.page_b_title_letters);
      b("15 blz B tekst", currentItem.page_b_text);

      f("16 blz C titel woord letters", currentItem.page_c_title_letters);
      b("17 blz C tekst", currentItem.page_c_text);

      b("18 handleiding", currentItem.handleiding_text);

      return md.join("\n");
    }

    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportMarkdown() {
      try {
        const md = buildMarkdownFromCurrent();
        const code = (currentItem?.code || "mpop").replace(/[^a-z0-9\-_.]/gi, "_");
        downloadTextFile(`${code}.md`, md);
        msg($("exportMsg"), "Markdown exported.");
      } catch (e) {
        msg($("exportMsg"), e.message || String(e), false);
      }
    }

    function exportPdf() {
      try {
        const md = buildMarkdownFromCurrent(); // reuse; PDF is text-based
        const code = (currentItem?.code || "mpop").replace(/[^a-z0-9\-_.]/gi, "_");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "a4" });

        const margin = 40;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const maxWidth = pageWidth - margin * 2;

        doc.setFont("courier", "normal");
        doc.setFontSize(10);

        const lines = doc.splitTextToSize(md, maxWidth);
        let y = margin;

        for (const line of lines) {
          if (y > pageHeight - margin) {
            doc.addPage();
            y = margin;
          }
          doc.text(line, margin, y);
          y += 12;
        }

        doc.save(`${code}.pdf`);
        msg($("exportMsg"), "PDF exported.");
      } catch (e) {
        msg($("exportMsg"), e.message || String(e), false);
      }
    }

    // -----------------------------
    // Config UI
    // -----------------------------
    function setConfigPrompt() {
      const existing = getCfg();
      const url = prompt("Supabase Project URL:", existing.url || "");
      if (!url) return;
      const key = prompt("Supabase anon public key:", existing.key || "");
      if (!key) return;

      localStorage.setItem("mpop_sb_url", url.trim());
      localStorage.setItem("mpop_sb_anon", key.trim());
      msg($("cfgMsg"), "Config saved locally in this browser.");

      // rebuild client and refresh UI
      sb = null;
      ensureClient();
      refreshAuthUI();
    }

    function clearConfig() {
      localStorage.removeItem("mpop_sb_url");
      localStorage.removeItem("mpop_sb_anon");
      msg($("cfgMsg"), "Saved config cleared.");
      sb = null;
      $("authLoggedOut").style.display = "block";
      $("authLoggedIn").style.display = "none";
      hideEditor();
    }

    // -----------------------------
    // Wire up
    // -----------------------------
    $("btnSetConfig").onclick = setConfigPrompt;
    $("btnClearConfig").onclick = clearConfig;

    $("btnSignIn").onclick = signIn;
    $("btnSignUp").onclick = signUp;
    $("btnSignOut").onclick = signOut;
    $("btnRefresh").onclick = loadItems;
    $("search").addEventListener("input", renderItems);

    $("btnSave").onclick = saveItem;
    $("btnReload").onclick = reloadItem;

    $("btnExportMd").onclick = exportMarkdown;
    $("btnExportPdf").onclick = exportPdf;

    // Boot
    window.addEventListener("load", async () => {
      try {
        const cfg = getCfg();
        if (!cfg.url || !cfg.key) {
          msg($("cfgMsg"), "No config saved yet. Click “Set / Change Supabase config”.", false);
          return;
        }
        ensureClient();
        sb.auth.onAuthStateChange(() => refreshAuthUI());
        await refreshAuthUI();
      } catch (e) {
        msg($("cfgMsg"), e.message || String(e), false);
      }
    });
  </script>
</body>
</html>