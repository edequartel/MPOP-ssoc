<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MPOP++ editor - Bartiméus Onderwijs</title>

  <link id="appStyles" rel="stylesheet" href="styles.css" />
</head>

<body>
  <h1>MPOP++ editor - Bartiméus Onderwijs</h1>
  <!--
  <div class="muted">
    Single-file HTML editor for your Supabase tables <span class="mono">mpop_items</span> and <span class="mono">mpop_sounds</span>.
    Uses Supabase Auth + RLS as the security boundary.
  </div>
-->

  <div class="hr"></div>

  <div class="row">
    <!-- LEFT: Auth + List -->
    <div class="column">
      <div class="card logo-card">
        <img
          id="logoImage"
          src="https://www.tastenbraille.com/braillestudio/resources/mpop/logo.png"
          data-full-url="https://www.tastenbraille.com/braillestudio/resources/mpop/kinderen.png"
          alt="MPOP logo"
        />
      </div>
      <div class="card">
        <h2 class="section-title">1 Log in</h2>
<!--
      <div class="tiny">Supabase config loaded from <span class="mono">/api/supabase-config</span>.</div>
    -->
        <div class="hr"></div>

        <div id="authLoggedOut">
          <label>Email</label>
          <input id="email" type="email" placeholder="name@school.nl" />

          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••" />

          <div class="btnrow mt-10">
            <button id="btnSignIn">Inloggen</button>
            <button id="btnSignUp">Registreren</button>
          </div>
          <div id="authMsg" class="tiny mt-10"></div>
        </div>

        <div id="authLoggedIn" class="hidden">
          <div class="kpi">
            <div class="pill">Signed in: <span id="userEmail" class="ok"></span></div>
            <div class="pill">Role: <span id="userRole" class="ok"></span></div>
          </div>
        <div class="btnrow mt-10">
          <button id="btnRefresh">Ververs lijst</button>
          <button id="btnSignOut">Log uit</button>
        </div>
      </div>
      </div>

      <div class="card" id="itemsCard">
        <h2 class="section-title">2 Kies item</h2>
        <div id="itemsLoggedOut" class="muted">Log in om items te bekijken.</div>
        <div id="itemsLoggedIn" class="hidden">
          <div id="listMsg" class="tiny mt-10"></div>
          <div class="list mt-8" id="itemsList"></div>
        </div>
      </div>

      <div class="card">
        <div class="btnrow">
          <button type="button" class="btn-like" onclick="window.open('readme.html','_blank','noreferrer')">Handleiding</button>
          <button type="button" class="btn-like" onclick="window.open('template.html','_blank','noreferrer')">Template</button>
          <button type="button" class="btn-like" onclick="window.open('mpop.html','_blank','noreferrer')">MPOP</button>
          <button type="button" class="btn-like" onclick="window.open('https://www.tastenbraille.com/braillestudio/versie1/Curriculum-Braille-maart-2025.pdf','_blank','noreferrer')">Curriculum</button>
          <button type="button" class="btn-like" onclick="window.open('https://www.tastenbraille.com/braillestudio/versie1/learning-through-play_web.pdf','_blank','noreferrer')">LTP</button>
          <button type="button" class="btn-like" onclick="window.open('https://www.tastenbraille.com/braillestudio/versie1/lego_acitiviteiten_braillebricks_NL_v3.pdf','_blank','noreferrer')">Lego Braillebricks</button>
          <button type="button" class="btn-like" onclick="window.open('https://www.tastenbraille.com/braillestudio/versie1/Ontwerprichtlijnen-voor-zweltekeningen.pdf','_blank','noreferrer')">Tekeningen</button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Editor -->
    <div class="card">
      <h2 class="section-title">3 Wijzig item</h2>
      <div id="editorHint" class="muted">Log in en kies item om te wijzigen.</div>

      <div id="editor" class="hidden">
        <div class="kpi">
          <div class="pill">Code: <span id="code" class="ok mono"></span></div>
          <div class="pill">Status: <span id="status" class="ok mono"></span></div>
          <div class="pill">Version: <span id="version" class="ok mono"></span></div>
          <div class="pill">Updated: <span id="updatedAt" class="ok mono"></span></div>
        </div>
        <div class="btnrow mt-10">
        </div>
        <div id="saveMsg" class="tiny mt-10 msg-placeholder"></div>

        <div class="btnrow mt-10">
          <button id="btnManualPdf" type="button" disabled>Handleiding</button>
          <button id="btnPdf" type="button" disabled>Multimodaal</button>
          <button id="btnPdfBraille" type="button" disabled>Braille</button>
        </div>

        <label>Auteur</label>
        <input id="auteur" />

        <label>Titel</label>
        <input id="title" />

        <label>Status</label>
        <select id="statusSelect">
          <option value="draft">draft</option>
          <option value="started">started</option>
          <option value="in_review">in_review</option>
          <option value="approved">approved</option>
        </select>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Inleiding</h2>

        <label>Handleiding</label>
        <textarea id="handleiding_text"></textarea>

        <label>Opmerkingen</label>
        <textarea id="remarks_handleiding"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 1</h2>

        <div class="split">
          <div>
            <label>Verhaal</label>
            <textarea id="story_text"></textarea>

            <div class="inlineRow">
              <input id="story_audio_path" placeholder="/sounds/nl/stories/bal-001.mp3" />
              <button id="btnPlayStoryAudio" disabled>Play</button>
            </div>
          </div>
          <div>
            <label>Klankzuiver</label>
            <textarea id="klankzuiver_text"></textarea>

            <div class="inlineRow">
              <input id="klankzuiver_letters" placeholder="/sounds/nl/klankzuiver/klankzuiver.mp3" />
              <button id="btnPlayKlankzuiverAudio" disabled>Play</button>
            </div>
          </div>
        </div>

        <div class="split">
          <div>
            <label>Afbeelding (path)</label>
            <input id="image1_path" placeholder="/resources/images/bal.png" data-preview-placeholder="true" />
            <img id="image1_preview" class="image-thumb" alt="image preview" />
          </div>
          <div></div>
        </div>

        <div class="split">
          <div>
            <label>Object beschrijving</label>
            <textarea id="object1_description"></textarea>

           <!-- <label>audio</label> -->
            
            <div class="inlineRow">
              <input id="object1_audio_path" placeholder="/sounds/nl/objects/object.mp3" />
              <button id="btnPlayAudioObject1" disabled>Play</button>
            </div>
          </div>

          <div>
          </div>
        </div>

        <label>Opmerkingen</label>
        <textarea id="remarks_1"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 2</h2>

        <div class="split">
          <div>
            <label>Geluid</label>
            <textarea id="woord_text"></textarea>

            <div class="inlineRow">
              <input id="woord_audio_path" class="extra-pad" placeholder="/sounds/general/sound.mp3" />
              <button id="btnPlayWoordAudio" disabled>Play</button>
            </div>
          </div>
          <div>
            <label>Opdracht 1</label>
            <textarea id="opdracht1_text"></textarea>

            <div class="inlineRow">
              <input id="opdracht1_audio_path" placeholder="/sounds/nl/opdracht/opdracht1.mp3" />
              <button id="btnPlayOpdracht1Audio" disabled>Play</button>
            </div>
          </div>
        </div>

        <div class="split">
          <div>
            <label>Afbeelding actief (path)</label>
            <input id="image2_path" placeholder="/resources/images/bal.png" data-preview-placeholder="true" />
            <img id="image2_preview" class="image-thumb" alt="image preview" />
          </div>
          <div></div>
        </div>

        <div class="split">
          <div>
            <label>Berschrijving afbeelding</label>
            <textarea id="object2_description"></textarea>

            <div class="inlineRow">
              <input id="object2_audio_path" placeholder="/sounds/nl/objects/beschrijving.mp3" />
              <button id="btnPlayAudioObject2" disabled>Play</button>
            </div>
          </div>
          <div>
            <label>Opdracht 2</label>
            <textarea id="opdracht2_text"></textarea>

            <div class="inlineRow">
              <input id="opdracht2_audio_path" placeholder="/sounds/nl/opdracht/opdracht2.mp3" />
              <button id="btnPlayOpdracht2Audio" disabled>Play</button>
            </div>
          </div>
        </div>

        <label>Opmerkingen</label>
        <textarea id="remarks_2"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 3</h2>

        <div class="split">
          <div>
            <label>Opdracht 3</label>
            <textarea id="opdracht3_text"></textarea>
            <div class="inlineRow">
              <input id="opdracht3_audio_path" placeholder="/sounds/nl/opdracht/opdracht3.mp3" />
              <button id="btnPlayOpdracht3Audio" disabled>Play</button>
            </div>
          </div>
          <div>
            <label>Opdracht 4</label>
            <textarea id="opdracht4_text"></textarea>
            <div class="inlineRow">
              <input id="opdracht4_audio_path" placeholder="/sounds/nl/opdracht/opdracht4.mp3" />
              <button id="btnPlayOpdracht4Audio" disabled>Play</button>
            </div>
          </div>
        </div>

        <label>Afbeelding 3 (path)</label>
        <input id="image3_path" placeholder="/resources/images/beeld3.png" />
        <img id="image3_preview" class="image-thumb" alt="image preview" />

        <div class="split">
          <div>
            <label>Object3</label>
            <textarea id="object3_description"></textarea>
            <div class="inlineRow">
              <input id="object3_audio_path" placeholder="/sounds/nl/object3.mp3" />
              <button id="btnPlayAudioObject3" disabled>Play</button>
            </div>
          </div>
          <div>
            <label>Opdracht 5</label>
            <textarea id="opdracht5_text"></textarea>
            <div class="inlineRow">
              <input id="opdracht5_audio_path" placeholder="/sounds/nl/opdracht/opdracht5.mp3" />
              <button id="btnPlayOpdracht5Audio" disabled>Play</button>
            </div>
          </div>
        </div>

        <label>Opmerkingen</label>
        <textarea id="remarks_3"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Braille algemeen</h2>

        <div class="btnrow mt-10">
          <button id="btnAddBraillePage" type="button">+ Braille pagina toevoegen</button>
        </div>

        <label>Opmerkingen</label>
        <textarea id="remarks_braille_algemeen"></textarea>

        <div class="inline-label">
          <label>&mdash; Lange klanken</label>
          <input id="lange_klanken" />
        </div>

        <div class="inline-label">
          <label>- Klinkers</label>
          <input id="klinkers" />
        </div>

        <div class="inline-label">
          <label>&gt; Medeklinkers</label>
          <input id="medeklinkers" />
        </div>

        <div class="inline-label">
          <label>|| Tweetekenklanken</label>
          <input id="tweetekenklanken" />
        </div>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Braille pagina's</h2>
        <div id="braillePages" class="mt-10"></div>
        <div class="hr"></div>
      </div>
    </div>
  </div>

  <div id="imageLightbox" aria-hidden="true">
    <button id="imageLightboxClose" type="button">Close</button>
    <img id="imageLightboxImg" alt="image preview large" />
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);
    const val = (id) => {
      const el = $(id);
      return el ? el.value : "";
    };
    const setVal = (id, value) => {
      const el = $(id);
      if (el) el.value = value ?? "";
    };
    const CONFIG_URL_LOCAL = "./supabase-config.js";
    const CONFIG_URL_REMOTE = "https://mpop-ssoc.vercel.app/api/supabase-config.js";
    const PDF_URL_LOCAL = "/api/pdf";
    const PDF_URL_REMOTE = "https://mpop-ssoc.vercel.app/api/pdf";
    const MANUAL_PDF_URL_LOCAL = "/api/manualpdf";
    const MANUAL_PDF_URL_REMOTE = "https://mpop-ssoc.vercel.app/api/manualpdf";
    const PDF_BRAILLE_URL_LOCAL = "/api/pdfbraille";
    const PDF_BRAILLE_URL_REMOTE = "https://mpop-ssoc.vercel.app/api/pdfbraille";
    const SHOW_FIELD_NAMES = false;

    const supabaseInit = async () => {
      try {
        let cfg = null;
        try {
          const mod = await import(CONFIG_URL_LOCAL);
          cfg = mod?.supabaseConfig || mod?.default || null;
          if (!cfg?.url || !cfg?.anonKey) {
            throw new Error("Local supabase-config.js missing url/anonKey.");
          }
        } catch (localErr) {
          const res = await fetch(CONFIG_URL_REMOTE);
          if (!res.ok) {
            const body = await res.text().catch(() => "");
            throw new Error(`Failed to load supabase-config (${res.status}). ${body}`.trim());
          }
          cfg = await res.json();
          if (!cfg?.url || !cfg?.anonKey) {
            throw new Error("Supabase config missing url/anonKey.");
          }
        }
        const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");
        return { client: createClient(cfg.url, cfg.anonKey), config: cfg, error: null };
      } catch (error) {
        console.error("Supabase init failed:", error);
        return { client: null, config: null, error };
      }
    };

    // -----------------------------
    // Supabase client + state
    // -----------------------------
    let sb = null;
    let currentItem = null; // full row from mpop_items
    let currentPagesByNo = new Map(); // page_no -> page row from mpop_pages
    let sounds = [];
    let authRefreshRunning = false;
    let authListenerBound = false;
    let isViewerRole = false;
    const audioPlayers = new Map();
    const AUDIO_ENDPOINT = "https://www.tastenbraille.com/braillestudio";
    const LOGO_AUDIO_URL = "https://www.tastenbraille.com/braillestudio/sounds/nl/stories/mpop-001.mp3";
    let logoAudioPlayer = null;
    const { client: sbClient, config: sbConfig, error: sbInitError } = await supabaseInit();
    sb = sbClient;
    // no UI display of config values

    function msg(el, text, ok=true) {
      el.innerHTML = text ? `<span class="${ok ? 'ok' : 'err'}">${escapeHtml(text)}</span>` : '';
    }
    function escapeHtml(s) {
      return (s ?? '').toString()
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }
    function formatDateTime(value) {
      if (!value) return "";
      const dt = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(dt.getTime())) return String(value);
      return dt.toLocaleString(undefined, {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function setButtonBusy(btn, busy, label = "Bezig...") {
      if (!btn) return;
      if (busy) {
        if (!btn.dataset.label) btn.dataset.label = btn.textContent || "";
        btn.textContent = label;
        btn.classList.add("busy");
        btn.disabled = true;
        return;
      }
      const prev = btn.dataset.label;
      if (prev !== undefined) btn.textContent = prev;
      btn.classList.remove("busy");
      delete btn.dataset.label;
    }


    const BRAILLE_LETTERS = {
      a: "⠁", b: "⠃", c: "⠉", d: "⠙", e: "⠑", f: "⠋", g: "⠛", h: "⠓", i: "⠊", j: "⠚",
      k: "⠅", l: "⠇", m: "⠍", n: "⠝", o: "⠕", p: "⠏", q: "⠟", r: "⠗", s: "⠎", t: "⠞",
      u: "⠥", v: "⠧", w: "⠺", x: "⠭", y: "⠽", z: "⠵"
    };
    const BRAILLE_DIGITS = {
      "1": "⠁", "2": "⠃", "3": "⠉", "4": "⠙", "5": "⠑",
      "6": "⠋", "7": "⠛", "8": "⠓", "9": "⠊", "0": "⠚"
    };
    const BRAILLE_PUNCT = {
      ".": "⠲", ",": "⠂", ";": "⠆", ":": "⠒", "?": "⠦", "!": "⠖",
      "-": "⠤", "'": "⠄", "\"": "⠶", "(": "⠷", ")": "⠾", "/": "⠌"
    };

    function toBraille(text) {
      const s = (text ?? "").toString();
      let out = "";
      let inNumber = false;
      for (const ch of s) {
        if (ch >= "0" && ch <= "9") {
          if (!inNumber) {
            out += "⠼";
            inNumber = true;
          }
          out += BRAILLE_DIGITS[ch] || ch;
          continue;
        }
        if (inNumber) inNumber = false;
        if (ch === " " || ch === "\n" || ch === "\t") {
          out += ch;
          continue;
        }
        const lower = ch.toLowerCase();
        if (BRAILLE_LETTERS[lower]) {
          out += BRAILLE_LETTERS[lower];
          continue;
        }
        if (BRAILLE_PUNCT[ch]) {
          out += BRAILLE_PUNCT[ch];
          continue;
        }
        out += ch;
      }
      return out;
    }

    function pageId(no, suffix) {
      return `pg_${no}_${suffix}`;
    }

    function getMaxPageNo() {
      let max = 0;
      for (const k of currentPagesByNo.keys()) {
        max = Math.max(max, Number(k) || 0);
      }
      return max;
    }

    function getPagesSortedByNo() {
      return Array.from(currentPagesByNo.values())
        .sort((a, b) => Number(a.page_no) - Number(b.page_no));
    }

    async function renumberPagesOrdered(orderedPages) {
      if (!currentItem?.id) return;
      if (!orderedPages?.length) return;
      const pageNos = orderedPages.map(p => Number(p.page_no));
      const minNo = Math.min(0, ...pageNos);
      const tempStart = minNo - 1000;
      const tempNos = orderedPages.map((_, i) => tempStart - i);

      for (let i = 0; i < orderedPages.length; i += 1) {
        const oldNo = Number(orderedPages[i].page_no);
        const tempNo = tempNos[i];
        const { error } = await sb
          .from("mpop_pages")
          .update({ page_no: tempNo })
          .eq("mpop_item_id", currentItem.id)
          .eq("page_no", oldNo);
        if (error) throw error;
      }

      for (let i = 0; i < orderedPages.length; i += 1) {
        const finalNo = i + 1;
        const tempNo = tempNos[i];
        const { error } = await sb
          .from("mpop_pages")
          .update({ page_no: finalNo })
          .eq("mpop_item_id", currentItem.id)
          .eq("page_no", tempNo);
        if (error) throw error;
      }
    }

    async function renumberPagesSequential() {
      const pages = getPagesSortedByNo();
      await renumberPagesOrdered(pages);
    }

    function getUnusedTempPageNo() {
      const existing = new Set(Array.from(currentPagesByNo.keys()).map(Number));
      let temp = -1;
      while (existing.has(temp)) temp -= 1;
      return temp;
    }

    function updatePageBraille(no) {
      setVal(pageId(no, "title_braille"), toBraille(val(pageId(no, "title_letters"))));
      setVal(pageId(no, "text_braille"), toBraille(val(pageId(no, "text"))));
    }

    function renderBraillePages() {
      const host = $("braillePages");
      if (!host) return;
      host.innerHTML = "";

      const pages = getPagesSortedByNo();

      for (const p of pages) {
        const no = Number(p.page_no);
        const card = document.createElement("div");
        card.className = "card mt-10";
        card.dataset.pageNo = String(no);

        const header = document.createElement("div");
        header.className = "split";
        const headerLeft = document.createElement("div");
        const headerTitle = document.createElement("h3");
        headerTitle.className = "section-title";
        headerTitle.textContent = `Braille pagina ${no}`;
        headerLeft.appendChild(headerTitle);
        const headerRight = document.createElement("div");
        headerRight.className = "header-right";
        const insertBtn = document.createElement("button");
        insertBtn.type = "button";
        insertBtn.className = "btn-small";
        insertBtn.textContent = "Voeg in na";
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "btn-small";
        deleteBtn.textContent = "Verwijder";
        headerRight.append(insertBtn, deleteBtn);
        header.append(headerLeft, headerRight);

        const interlineRow = document.createElement("div");
        interlineRow.className = "split";
        const interlineLeft = document.createElement("div");
        const interlineLabel = document.createElement("label");
        interlineLabel.className = "checkbox-row";
        const interlineInput = document.createElement("input");
        interlineInput.id = pageId(no, "interlinie_on");
        interlineInput.type = "checkbox";
        interlineInput.className = "checkbox";
        interlineInput.checked = !!p.interlinie_on;
        const interlineText = document.createElement("span");
        interlineText.textContent = "Interline on";
        interlineLabel.append(interlineInput, interlineText);
        interlineLeft.appendChild(interlineLabel);
        interlineRow.append(interlineLeft, document.createElement("div"));

        const titleRow = document.createElement("div");
        titleRow.className = "split";
        const titleLeft = document.createElement("div");
        const titleLabel = document.createElement("label");
        titleLabel.textContent = "Titel";
        const titleInput = document.createElement("input");
        titleInput.id = pageId(no, "title_letters");
        titleInput.value = p.title_letters || "";
        titleLeft.append(titleLabel, titleInput);
        const titleRight = document.createElement("div");
        const titleBrailleLabel = document.createElement("label");
        titleBrailleLabel.textContent = "Titel (braille)";
        const titleBrailleInput = document.createElement("input");
        titleBrailleInput.id = pageId(no, "title_braille");
        titleBrailleInput.readOnly = true;
        titleRight.append(titleBrailleLabel, titleBrailleInput);
        titleRow.append(titleLeft, titleRight);

        const textRow = document.createElement("div");
        textRow.className = "split";
        const textLeft = document.createElement("div");
        const textLabel = document.createElement("label");
        textLabel.textContent = "Tekst";
        const textInput = document.createElement("textarea");
        textInput.id = pageId(no, "text");
        textInput.value = p.text || "";
        textLeft.append(textLabel, textInput);
        const textRight = document.createElement("div");
        const textBrailleLabel = document.createElement("label");
        textBrailleLabel.textContent = "Tekst (braille)";
        const textBrailleInput = document.createElement("textarea");
        textBrailleInput.id = pageId(no, "text_braille");
        textBrailleInput.readOnly = true;
        textRight.append(textBrailleLabel, textBrailleInput);
        textRow.append(textLeft, textRight);

        const remarksLabel = document.createElement("label");
        remarksLabel.textContent = "Opmerkingen";
        const remarksInput = document.createElement("textarea");
        remarksInput.id = pageId(no, "remarks");
        remarksInput.value = p.remarks || "";

        const wireAutosave = (el, shouldUpdateBraille = false) => {
          if (!el) return;
          const handler = () => {
            if (shouldUpdateBraille) updatePageBraille(no);
            scheduleAutosave();
          };
          el.addEventListener("input", handler);
          el.addEventListener("change", handler);
        };

        wireAutosave(titleInput, true);
        wireAutosave(textInput, true);
        wireAutosave(interlineInput, false);
        wireAutosave(remarksInput, false);

        deleteBtn.onclick = async () => {
          try {
            if (!currentItem?.id) return;
            suppressAutosaveUntil = Date.now() + 5000;
            msg($("saveMsg"), `Braille pagina ${no} verwijderen...`);
            const { error } = await sb
              .from("mpop_pages")
              .delete()
              .eq("mpop_item_id", currentItem.id)
              .eq("page_no", no);
            if (error) throw error;
            await loadPagesForItem(currentItem.id);
            await renumberPagesSequential();
            await loadPagesForItem(currentItem.id);
            renderBraillePages();
            msg($("saveMsg"), `Braille pagina ${no} verwijderd en hergenummerd.`);
          } catch (e) {
            msg($("saveMsg"), e.message || String(e), false);
          }
        };

        insertBtn.onclick = async () => {
          try {
            if (!currentItem?.id) return;
            suppressAutosaveUntil = Date.now() + 5000;
            msg($("saveMsg"), `Braille pagina invoegen na ${no}...`);
            const tempNo = getUnusedTempPageNo();
            const row = {
              mpop_item_id: currentItem.id,
              page_no: tempNo,
              title_letters: "",
              text: "",
              remarks: "",
              interlinie_on: false,
            };
            const { error: insertError } = await sb
              .from("mpop_pages")
              .insert(row);
            if (insertError) throw insertError;

            const ordered = [];
            const pages = getPagesSortedByNo();
            for (const p of pages) {
              ordered.push(p);
              if (Number(p.page_no) === no) {
                ordered.push({ page_no: tempNo });
              }
            }
            if (!ordered.some(p => Number(p.page_no) === tempNo)) {
              ordered.push({ page_no: tempNo });
            }
            await renumberPagesOrdered(ordered);
            await loadPagesForItem(currentItem.id);
            renderBraillePages();
            msg($("saveMsg"), `Braille pagina ingevoegd na ${no}.`);
          } catch (e) {
            msg($("saveMsg"), e.message || String(e), false);
          }
        };

        card.append(header, interlineRow, titleRow, textRow, remarksLabel, remarksInput);
        if (isViewerRole) {
          for (const el of card.querySelectorAll("input, textarea, button")) {
            el.disabled = true;
          }
        }
        host.appendChild(card);
        updatePageBraille(no);
      }
    }

    async function addEmptyBraillePage() {
      if (!currentItem?.id) return;
      const nextNo = getMaxPageNo() + 1;

      const row = {
        mpop_item_id: currentItem.id,
        page_no: nextNo,
        title_letters: "",
        text: "",
        remarks: "",
        interlinie_on: false,
      };

      const { error } = await sb
        .from("mpop_pages")
        .insert(row);

      if (error) throw error;

      await loadPagesForItem(currentItem.id);
      await renumberPagesSequential();
      await loadPagesForItem(currentItem.id);
      renderBraillePages();
      msg($("saveMsg"), `Braille pagina ${nextNo} toegevoegd en hergenummerd`);
    }

    function setEditorReadonly(readonly) {
      for (const el of document.querySelectorAll("#editor input, #editor textarea, #editor select, #editor button")) {
        if (el.tagName === "BUTTON") {
          const btnId = el.id || "";
          if (btnId.startsWith("btnPlay") || el.classList.contains("btnSoundPlay") || btnId === "toggleFieldNames") {
            el.disabled = false;
            continue;
          }
        }
        el.disabled = readonly;
      }
    }

    function initFieldNameToggle() {
      if (!SHOW_FIELD_NAMES) return;
      for (const label of document.querySelectorAll("label")) {
        const direct = label.nextElementSibling;
        const field = (label.matches("input, textarea, select") ? label : null)
          || label.querySelector("input, textarea, select")
          || (direct && direct.matches("input, textarea, select") ? direct : null)
          || (direct ? direct.querySelector("input, textarea, select") : null);
        if (field && field.id) {
          label.dataset.fieldId = field.id;
          const target = label.querySelector("span") || label;
          const suffix = ` (${field.id})`;
          if (!target.textContent.includes(suffix)) {
            target.textContent += suffix;
          }
        }
      }
    }
    document.addEventListener("DOMContentLoaded", initFieldNameToggle);

    function ensureClient() {
      if (sbInitError) {
        throw new Error(`Supabase init failed: ${sbInitError.message || sbInitError}`);
      }
      if (!sb) {
        throw new Error("Supabase client not ready.");
      }
      return sb;
    }

    // -----------------------------
    // Pages (mpop_pages)
    // -----------------------------
    async function loadPagesForItem(itemId) {
      currentPagesByNo.clear();
      if (!itemId) return;

      const { data, error } = await sb
        .from("mpop_pages")
        .select("page_no, title_letters, text, remarks, interlinie_on")
        .eq("mpop_item_id", itemId)
        .order("page_no", { ascending: true });

      if (error) {
        console.error("loadPagesForItem error:", error);
        throw error;
      }

      console.log("Loaded mpop_pages:", data);

      for (const p of data || []) {
        currentPagesByNo.set(Number(p.page_no), p);
      }
    }

    async function upsertPagesFromDynamicUI() {
      if (!currentItem?.id) return;
      const host = $("braillePages");
      if (!host) return;
      const cards = host.querySelectorAll("[data-page-no]");
      const rows = [];
      for (const card of cards) {
        const no = Number(card.dataset.pageNo);
        const titleEl = card.querySelector(`#${pageId(no, "title_letters")}`);
        const textEl = card.querySelector(`#${pageId(no, "text")}`);
        const remarksEl = card.querySelector(`#${pageId(no, "remarks")}`);
        const interlineEl = card.querySelector(`#${pageId(no, "interlinie_on")}`);
        rows.push({
          mpop_item_id: currentItem.id,
          page_no: no,
          title_letters: titleEl?.value ?? "",
          text: textEl?.value ?? "",
          remarks: remarksEl?.value ?? "",
          interlinie_on: !!interlineEl?.checked,
        });
      }
      if (!rows.length) return;

      const { error } = await sb
        .from("mpop_pages")
        .upsert(rows, { onConflict: "mpop_item_id,page_no" });

      if (error) throw error;

      await loadPagesForItem(currentItem.id);
      renderBraillePages();
    }

    // -----------------------------
    // Auth
    // -----------------------------
    async function refreshAuthUI(passedSession) {
      if (!sb || authRefreshRunning) return;
      authRefreshRunning = true;
      let session = passedSession ?? null;
      try {
        if (!session) {
          const { data } = await sb.auth.getSession();
          session = data?.session ?? null;
        }
      const loggedIn = !!session?.user;
      $("authLoggedOut").style.display = loggedIn ? "none" : "block";
      $("authLoggedIn").style.display  = loggedIn ? "block" : "none";
      $("itemsLoggedOut").style.display = loggedIn ? "none" : "block";
      $("itemsLoggedIn").style.display  = loggedIn ? "block" : "none";

      if (loggedIn) {
        $("userEmail").textContent = session.user.email || "(no email)";

        // Fetch role from profiles (requires your RLS policy)
        const { data: prof, error } = await sb
          .from("profiles")
          .select("role, display_name")
          .eq("user_id", session.user.id)
          .maybeSingle();

        const role = error ? "unknown" : (prof?.role || "unknown");
        $("userRole").textContent = role;
        isViewerRole = role === "viewer";
        setEditorReadonly(isViewerRole);

        await loadItems();
      } else {
        $("itemsList").innerHTML = "";
        hideEditor();
        isViewerRole = false;
      }
      } finally {
        authRefreshRunning = false;
      }
    }

    async function signIn() {
      try {
        ensureClient();
        msg($("authMsg"), "");
        const email = val("email").trim();
        const password = val("password");
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        msg($("authMsg"), "Signed in.");
        await refreshAuthUI(data?.session ?? null);
      } catch (e) {
        msg($("authMsg"), e.message || String(e), false);
      }
    }

    async function signUp() {
      try {
        ensureClient();
        msg($("authMsg"), "");
        const email = val("email").trim();
        const password = val("password");
        const { error } = await sb.auth.signUp({ email, password });
        if (error) throw error;
        msg($("authMsg"), "Registratie gelukt. Bevestig je e-mail voordat je kunt inloggen.");
      } catch (e) {
        msg($("authMsg"), e.message || String(e), false);
      }
    }

    async function signOut() {
      try {
        msg($("listMsg"), "");
        await sb.auth.signOut();
        await refreshAuthUI();
      } catch (e) {
        msg($("listMsg"), e.message || String(e), false);
      }
    }

    // -----------------------------
    // Items list + selection
    // -----------------------------
    async function loadItems() {
      try {
        msg($("listMsg"), "Loading...");
        const { data, error } = await sb
          .from("mpop_items")
          .select("id, code, title, status, updated_at, version, sort_index, woord_groep")
          .order("sort_index", { ascending: true });

        if (error) throw error;

        renderItems(data || []);
        msg($("listMsg"), `Loaded ${data?.length || 0} items.`);
      } catch (e) {
        msg($("listMsg"), e.message || String(e), false);
      }
    }

    function renderItems(items) {
      const filtered = items;

      const host = $("itemsList");
      host.innerHTML = "";

      for (const it of filtered) {
        const b = document.createElement("button");
        b.className = "itembtn";
        const title = it.title || "(no title)";
        const status = it.status || "no status";
        const label = document.createElement("span");
        label.className = "item-label";
        label.textContent = title;
        const dot = document.createElement("span");
        dot.className = "status-dot";
        dot.dataset.status = status || "";
        if (it.woord_groep !== null && it.woord_groep !== undefined) {
          b.dataset.woordGroep = String(it.woord_groep);
        }
        b.append(label, dot);
        b.onclick = () => selectItem(it.id);
        host.appendChild(b);
      }
    }

    async function selectItem(id) {
      try {
        msg($("saveMsg"), "");
        const { data, error } = await sb
          .from("mpop_items")
          .select("*")
          .eq("id", id)
          .single();
        if (error) throw error;

        currentItem = data;
        await loadPagesForItem(id);
        console.log("Pages loaded for item", id, Array.from(currentPagesByNo.values()));
        renderBraillePages();
        showEditor(data);
        updatePdfButton();
        await loadSounds();
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      }
    }

    function hideEditor() {
      $("editorHint").style.display = "block";
      $("editor").style.display = "none";
      currentItem = null;
      updatePdfButton();
    }

    let autosaveTimer = null;
    let autosaveRunning = false;
    let suppressAutosaveUntil = 0; // epoch ms: prevent autosave overwriting saveMsg during explicit actions

function scheduleAutosave() {
  if (isViewerRole) return;
  if (!currentItem) return;
  if (Date.now() < suppressAutosaveUntil) return;
  if (autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(async () => {
        if (autosaveRunning || !currentItem) return;
        autosaveRunning = true;
        try {
          msg($("saveMsg"), "Autosaving...");
          await saveItem();
        } finally {
          autosaveRunning = false;
        }
      }, 1500);
    }

    function showEditor(row) {
      $("editorHint").style.display = "none";
      $("editor").style.display = "block";

      $("code").textContent = row.code || "";
      $("status").textContent = row.status || "";
      $("version").textContent = String(row.version ?? "");
      $("updatedAt").textContent = formatDateTime(row.updated_at);

      setVal("auteur", row.auteur || "");
      setVal("title", row.title || "");
      setVal("statusSelect", row.status || "draft");

      setVal("story_text", row.story_text || "");
      setVal("object1_description", row.object1_description || "");
      setVal("object1_audio_path", row.object1_audio_path || "");
      setVal("klankzuiver_text", row.klankzuiver_text || "");
      setVal("klankzuiver_letters", row.klankzuiver_audio_path || "");
      setVal("opdracht1_text", row.opdracht1_text || "");
      setVal("opdracht2_text", row.opdracht2_text || "");
      setVal("opdracht3_text", row.opdracht3_text || "");
      setVal("opdracht4_text", row.opdracht4_text || "");
      setVal("opdracht5_text", row.opdracht5_text || "");
      setVal("object3_description", row.object3_description || "");
      setVal("image3_path", row.image3_path || "");
      setVal("woord_text", row.woord_text || "");
      setVal("object2_description", row.object2_description || "");
      setVal("remarks_1", row.remarks_1 || "");
      setVal("remarks_2", row.remarks_2 || "");
      renderBraillePages();
      setVal("remarks_3", row.remarks_3 || "");
      setVal("remarks_braille_algemeen", row.remarks_braille_algemeen || "");
      setVal("lange_klanken", row.lange_klanken || "");
      setVal("klinkers", row.klinkers || "");
      setVal("medeklinkers", row.medeklinkers || "");
      setVal("tweetekenklanken", row.tweetekenklanken || "");
      setVal("handleiding_text", row.handleiding_text || "");
      setVal("remarks_handleiding", row.remarks_handleiding || "");

      // paths
      setVal("story_audio_path", row.story_audio_path || "");
      setVal("opdracht1_audio_path", row.opdracht1_audio_path || "");
      setVal("opdracht2_audio_path", row.opdracht2_audio_path || "");
      setVal("opdracht3_audio_path", row.opdracht3_audio_path || "");
      setVal("opdracht4_audio_path", row.opdracht4_audio_path || "");
      setVal("object3_audio_path", row.object3_audio_path || "");
      setVal("opdracht5_audio_path", row.opdracht5_audio_path || "");
      setVal("woord_audio_path", row.woord_audio_path || "");
      setVal("object2_audio_path", row.object2_audio_path || "");
      setVal("image1_path", row.image1_path || "");
      setVal("image2_path", row.image2_path || "");
      setVal("image3_path", row.image3_path || "");

      setPlayButton("btnPlayStoryAudio", val("story_audio_path"));
      setPlayButton("btnPlayAudioObject1", val("object1_audio_path"));
      setPlayButton("btnPlayOpdracht1Audio", val("opdracht1_audio_path"));
      setPlayButton("btnPlayOpdracht2Audio", val("opdracht2_audio_path"));
      setPlayButton("btnPlayOpdracht3Audio", val("opdracht3_audio_path"));
      setPlayButton("btnPlayOpdracht4Audio", val("opdracht4_audio_path"));
      setPlayButton("btnPlayAudioObject3", val("object3_audio_path"));
      setPlayButton("btnPlayOpdracht5Audio", val("opdracht5_audio_path"));
      setPlayButton("btnPlayWoordAudio", val("woord_audio_path"));
      setPlayButton("btnPlayAudioObject2", val("object2_audio_path"));
      setPlayButton("btnPlayKlankzuiverAudio", val("klankzuiver_letters"));
      updateImagePreview("image1_path", "image1_preview");
      updateImagePreview("image2_path", "image2_preview");
      updateImagePreview("image3_path", "image3_preview");

    }

    function updatePdfButton() {
      $("btnPdf").disabled = !currentItem?.id;
      $("btnManualPdf").disabled = !currentItem?.id;
      $("btnPdfBraille").disabled = !currentItem?.id;
    }

    async function flushAutosaveForPdf() {
      if (autosaveTimer) {
        clearTimeout(autosaveTimer);
        autosaveTimer = null;
      }
      if (isViewerRole || !currentItem) return;
      if (autosaveRunning) {
        await new Promise((resolve) => {
          const tick = () => {
            if (!autosaveRunning) return resolve();
            setTimeout(tick, 100);
          };
          tick();
        });
      }
      await saveItem(false);
    }

    // -----------------------------
    // Save (optimistic concurrency via version)
    // -----------------------------
    async function saveItem(showMsg = true) {
      if (!currentItem) return;
      try {
        if (showMsg) msg($("saveMsg"), "Saving...");
        const payload = {
          auteur: val("auteur").trim(),
          title: val("title").trim(),
          status: val("statusSelect"),

          story_text: val("story_text"),
          object1_description: val("object1_description").trim(),
          object1_audio_path: val("object1_audio_path").trim(),
          klankzuiver_text: val("klankzuiver_text"),
          klankzuiver_audio_path: val("klankzuiver_letters").trim(),

          opdracht1_text: val("opdracht1_text"),
          opdracht2_text: val("opdracht2_text"),
          opdracht3_text: val("opdracht3_text"),
          opdracht4_text: val("opdracht4_text"),
          opdracht5_text: val("opdracht5_text"),
          object3_description: val("object3_description"),

          woord_text: val("woord_text"),

          object2_description: val("object2_description"),

          story_audio_path: val("story_audio_path").trim(),
          opdracht1_audio_path: val("opdracht1_audio_path").trim(),
          opdracht2_audio_path: val("opdracht2_audio_path").trim(),
          opdracht3_audio_path: val("opdracht3_audio_path").trim(),
          opdracht4_audio_path: val("opdracht4_audio_path").trim(),
          object3_audio_path: val("object3_audio_path").trim(),
          opdracht5_audio_path: val("opdracht5_audio_path").trim(),
          woord_audio_path: val("woord_audio_path").trim(),
          object2_audio_path: val("object2_audio_path").trim(),
          image1_path: val("image1_path").trim(),
          image2_path: val("image2_path").trim(),
          image3_path: val("image3_path").trim(),

          remarks_1: val("remarks_1"),

          remarks_2: val("remarks_2"),

          remarks_3: val("remarks_3"),

          remarks_braille_algemeen: val("remarks_braille_algemeen"),
          lange_klanken: val("lange_klanken"),
          klinkers: val("klinkers"),
          medeklinkers: val("medeklinkers"),
          tweetekenklanken: val("tweetekenklanken"),

          handleiding_text: val("handleiding_text"),
          remarks_handleiding: val("remarks_handleiding"),
        };

        // Only update if version matches what we loaded
        const { data, error } = await sb
          .from("mpop_items")
          .update(payload)
          .eq("id", currentItem.id)
          .eq("version", currentItem.version)
          .select("*")
          .maybeSingle();

        if (error) throw error;

        if (!data) {
          throw new Error("Conflict: the item was updated by someone else. Click Reload item and retry.");
        }

        currentItem = data;
        await upsertPagesFromDynamicUI();
        showEditor(data);
        if (showMsg) msg($("saveMsg"), "Saved.");
        await loadItems();
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      }
    }

    async function reloadItem() {
      if (!currentItem) return;
      await selectItem(currentItem.id);
      msg($("saveMsg"), "Reloaded.");
    }

    // -----------------------------
    // Audio playback (endpoint + path)
    // -----------------------------
    function buildAudioUrl(path) {
      const trimmed = (path || "").trim();
      if (!trimmed) return "";
      if (trimmed.startsWith("http://") || trimmed.startsWith("https://")) {
        return trimmed;
      }
      const base = AUDIO_ENDPOINT.replace(/\/+$/,"");
      const suffix = trimmed.startsWith("/") ? trimmed : "/" + trimmed;
      return base + suffix;
    }

    function buildImageUrl(path) {
      return buildAudioUrl(path);
    }

    function updateImagePreview(inputId, imgId) {
      const img = $(imgId);
      const input = $(inputId);
      const path = (input.value || "").trim();
      const url = buildImageUrl(path);
      if (!url) {
        img.style.display = "none";
        img.removeAttribute("src");
        img.removeAttribute("data-full-url");
        return;
      }
      img.src = url;
      img.dataset.fullUrl = url;
      img.onerror = () => {
        img.style.display = "none";
        img.removeAttribute("src");
        img.removeAttribute("data-full-url");
      };
      img.style.display = "block";
    }

    function openImageLightbox(url, altText) {
      const lightbox = $("imageLightbox");
      const lightboxImg = $("imageLightboxImg");
      if (!url) return;
      lightboxImg.src = url;
      lightboxImg.alt = altText || "image preview large";
      lightbox.style.display = "flex";
      lightbox.setAttribute("aria-hidden", "false");
    }

    function closeImageLightbox() {
      const lightbox = $("imageLightbox");
      const lightboxImg = $("imageLightboxImg");
      lightbox.style.display = "none";
      lightbox.setAttribute("aria-hidden", "true");
      lightboxImg.removeAttribute("src");
      stopLogoAudio();
    }

    function wireImagePreview(imgId) {
      const img = $(imgId);
      img.addEventListener("click", () => {
        const url = img.dataset.fullUrl || img.getAttribute("src");
        if (url) openImageLightbox(url, img.alt);
      });
    }

    function setPlayButton(btnId, path) {
      const btn = $(btnId);
      btn.disabled = !path || !path.trim();
      btn.textContent = "Play";
    }

    function wireAudioInput(inputId, btnId) {
      const input = $(inputId);
      input.addEventListener("input", () => setPlayButton(btnId, input.value));
    }

    function toggleAudio(btn, path) {
      const url = buildAudioUrl(path);
      if (!url) throw new Error("No audio path saved for this field yet.");
      let player = audioPlayers.get(url);
      if (!player) {
        player = new Audio(url);
        audioPlayers.set(url, player);
        player.addEventListener("ended", () => { btn.textContent = "Play"; });
      }
      if (!player.paused) {
        player.pause();
        btn.textContent = "Play";
        return;
      }
      for (const [otherUrl, otherPlayer] of audioPlayers.entries()) {
        if (otherUrl !== url && !otherPlayer.paused) {
          otherPlayer.pause();
          otherPlayer.currentTime = 0;
        }
      }
      for (const otherBtn of document.querySelectorAll("button[id^='btnPlay'], .btnSoundPlay")) {
        if (otherBtn !== btn) otherBtn.textContent = "Play";
      }
      btn.textContent = "Pause";
      player.play();
    }

    function playLogoAudio() {
      if (!logoAudioPlayer) {
        logoAudioPlayer = new Audio(LOGO_AUDIO_URL);
      }
      logoAudioPlayer.currentTime = 0;
      logoAudioPlayer.play();
    }

    function stopLogoAudio() {
      if (!logoAudioPlayer) return;
      if (!logoAudioPlayer.paused) {
        logoAudioPlayer.pause();
      }
      logoAudioPlayer.currentTime = 0;
    }

    // -----------------------------
    // Storage helpers (upload + signed links)
    // -----------------------------
    function mustHaveCode() {
      const code = (currentItem?.code || "").trim();
      if (!code) throw new Error("This item has no code. Set code in the database (mpop_items.code).");
      return code;
    }

    async function uploadToBucket(bucket, path, file) {
      const { error } = await sb.storage.from(bucket).upload(path, file, { upsert: true });
      if (error) throw error;
      return path;
    }

    async function signedLink(bucket, path, expiresSeconds = 3600) {
      const { data, error } = await sb.storage.from(bucket).createSignedUrl(path, expiresSeconds);
      if (error) throw error;
      return data.signedUrl;
    }

    async function uploadAndSetField({ bucket, fileInputId, dbField, defaultName }) {
      if (!currentItem) return;
      const code = mustHaveCode();
      const file = $(fileInputId).files?.[0];
      if (!file) throw new Error("Select a file first.");
      const ext = (file.name.split(".").pop() || "").toLowerCase();
      const safeExt = ext ? "." + ext : "";
      const path = `${code}/${defaultName}${safeExt}`;

      await uploadToBucket(bucket, path, file);

      // Update only the path field; still protect with version
      const payload = {};
      payload[dbField] = path;

      const { data, error } = await sb
        .from("mpop_items")
        .update(payload)
        .eq("id", currentItem.id)
        .eq("version", currentItem.version)
        .select("*")
        .maybeSingle();

      if (error) throw error;
      if (!data) throw new Error("Conflict while saving the file path. Reload item and retry.");

      currentItem = data;
      showEditor(data);
      await loadItems();
      return path;
    }

    async function linkForField({ bucket, dbField, outElId }) {
      if (!currentItem) return;
      const path = currentItem[dbField];
      if (!path) throw new Error("No file path saved for this field yet.");
      const url = await signedLink(bucket, path, 3600);
      $(outElId).innerHTML = `<a href="${url}" target="_blank" rel="noreferrer">Open (valid 1 hour)</a>`;
    }

    // -----------------------------
    // Sounds (mpop_sounds)
    // -----------------------------
    async function loadSounds() {
      if (!currentItem) return;
      if (!$("soundsList") || !$("soundsMsg")) return;
      const { data, error } = await sb
        .from("mpop_sounds")
        .select("id, label, audio_path, sort_order")
        .eq("mpop_item_id", currentItem.id)
        .order("sort_order", { ascending: true });

      if (error) {
        msg($("soundsMsg"), error.message, false);
        return;
      }

      sounds = data || [];
      renderSounds();
        msg($("soundsMsg"), "");
    }

    function renderSounds() {
      const host = $("soundsList");
      if (!host) return;
      host.innerHTML = "";

      if (!sounds.length) return;

      for (const s of sounds) {
        const wrap = document.createElement("div");
        wrap.className = "card";
        wrap.style.padding = "10px";
        wrap.innerHTML = `
          <div class="kpi">
            <div class="pill">Label: <span class="ok mono">${escapeHtml(s.label || "")}</span></div>
            <div class="pill">Order: <span class="ok mono">${escapeHtml(String(s.sort_order ?? 0))}</span></div>
          </div>
          <label class="mt-8">Audio path (audio_path)</label>
          <div class="inlineRow">
            <input value="${escapeHtml(s.audio_path || "")}" readonly />
            <button data-id="${s.id}" class="btnSoundPlay" ${s.audio_path ? "" : "disabled"}>Play</button>
          </div>
        `;
        host.appendChild(wrap);
      }

      for (const btn of document.querySelectorAll(".btnSoundPlay")) {
        btn.onclick = async () => {
          try {
            const id = btn.getAttribute("data-id");
            const sound = sounds.find(x => x.id === id);
            if (!sound?.audio_path) throw new Error("No audio_path.");
            toggleAudio(btn, sound.audio_path);
          } catch (e) {
            msg($("soundsMsg"), e.message || String(e), false);
          }
        };
      }
    }

    // -----------------------------
    // Wire up buttons
    // -----------------------------
    $("btnSignIn").onclick = signIn;
    $("btnSignUp").onclick = signUp;

    $("btnSignOut").onclick = signOut;
    $("btnRefresh").onclick = () => loadItems();
    $("btnPdf").onclick = async () => {
      try {
        if (!currentItem?.id) return;
        setButtonBusy($("btnPdf"), true, "PDF bezig...");
        msg($("saveMsg"), "PDF wordt gemaakt...");
        await flushAutosaveForPdf();
        const { data } = await sb.auth.getSession();
        const token = data?.session?.access_token;
        const qs = `?id=${encodeURIComponent(currentItem.id)}`;
        let r = await fetch(`${PDF_URL_LOCAL}${qs}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (r.status === 404) {
          r = await fetch(`${PDF_URL_REMOTE}${qs}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
        }
        if (!r.ok) {
          const body = await r.text().catch(() => "");
          throw new Error(`PDF failed (${r.status}). ${body}`.trim());
        }
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const rawTitle = (currentItem?.title || "").trim();
        const safeTitle = rawTitle
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
        const fileId = safeTitle || String(currentItem?.id || "mpop");
        a.download = `mpop-${fileId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
        msg($("saveMsg"), "PDF gereed.");
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      } finally {
        setButtonBusy($("btnPdf"), false);
        updatePdfButton();
      }
    };
    $("btnPdfBraille").onclick = async () => {
      try {
        if (!currentItem?.id) return;
        setButtonBusy($("btnPdfBraille"), true, "Braille bezig...");
        msg($("saveMsg"), "Braille PDF wordt gemaakt...");
        await flushAutosaveForPdf();
        const { data } = await sb.auth.getSession();
        const token = data?.session?.access_token;
        const qs = `?id=${encodeURIComponent(currentItem.id)}`;
        let r = await fetch(`${PDF_BRAILLE_URL_LOCAL}${qs}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (r.status === 404) {
          r = await fetch(`${PDF_BRAILLE_URL_REMOTE}${qs}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
        }
        if (!r.ok) {
          const body = await r.text().catch(() => "");
          throw new Error(`Braille PDF failed (${r.status}). ${body}`.trim());
        }
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const rawTitle = (currentItem?.title || "").trim();
        const safeTitle = rawTitle
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
        const fileId = safeTitle || String(currentItem?.id || "mpop");
        a.download = `mpop-${fileId}-braille.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
        msg($("saveMsg"), "Braille PDF gereed.");
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      } finally {
        setButtonBusy($("btnPdfBraille"), false);
        updatePdfButton();
      }
    };

    $("btnManualPdf").onclick = async () => {
      try {
        if (!currentItem?.id) return;
        setButtonBusy($("btnManualPdf"), true, "Manual bezig...");
        msg($("saveMsg"), "Manual PDF wordt gemaakt...");
        await flushAutosaveForPdf();
        const { data } = await sb.auth.getSession();
        const token = data?.session?.access_token;
        const qs = `?id=${encodeURIComponent(currentItem.id)}`;
        let r = await fetch(`${MANUAL_PDF_URL_LOCAL}${qs}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (r.status === 404) {
          r = await fetch(`${MANUAL_PDF_URL_REMOTE}${qs}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
        }
        if (!r.ok) {
          const body = await r.text().catch(() => "");
          throw new Error(`Manual PDF failed (${r.status}). ${body}`.trim());
        }
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const rawTitle = (currentItem?.title || "").trim();
        const safeTitle = rawTitle
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
        const fileId = safeTitle || String(currentItem?.id || "mpop");
        a.download = `mpop-manual-${fileId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
        msg($("saveMsg"), "Manual PDF gereed.");
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      } finally {
        setButtonBusy($("btnManualPdf"), false);
        updatePdfButton();
      }
    };

    const btnAddBraillePage = $("btnAddBraillePage");
    if (btnAddBraillePage) {
      btnAddBraillePage.onclick = async (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        try {
          await addEmptyBraillePage();
        } catch (e) {
          msg($("saveMsg"), e.message || String(e), false);
        }
      };
    }

    const searchInput = $("search");
    if (searchInput) {
      searchInput.addEventListener("input", async () => {
        // re-render from last loaded list by reloading quickly:
        // simplest: just reload items; if you prefer client-side filtering only, store items list.
        await loadItems();
      });
    }


    for (const el of document.querySelectorAll("#editor input, #editor textarea, #editor select")) {
      el.addEventListener("input", scheduleAutosave);
      el.addEventListener("change", scheduleAutosave);
    }

    $("btnPlayStoryAudio").onclick = () => {
      try { toggleAudio($("btnPlayStoryAudio"), val("story_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayAudioObject1").onclick = () => {
      try { toggleAudio($("btnPlayAudioObject1"), val("object1_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayKlankzuiverAudio").onclick = () => {
      try { toggleAudio($("btnPlayKlankzuiverAudio"), val("klankzuiver_letters")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht1Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht1Audio"), val("opdracht1_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht2Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht2Audio"), val("opdracht2_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht3Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht3Audio"), val("opdracht3_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht4Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht4Audio"), val("opdracht4_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayAudioObject3").onclick = () => {
      try { toggleAudio($("btnPlayAudioObject3"), val("object3_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht5Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht5Audio"), val("opdracht5_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayWoordAudio").onclick = () => {
      try { toggleAudio($("btnPlayWoordAudio"), val("woord_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayAudioObject2").onclick = () => {
      try { toggleAudio($("btnPlayAudioObject2"), val("object2_audio_path")); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };

    wireAudioInput("story_audio_path", "btnPlayStoryAudio");
    wireAudioInput("object1_audio_path", "btnPlayAudioObject1");
    wireAudioInput("klankzuiver_letters", "btnPlayKlankzuiverAudio");
    wireAudioInput("opdracht1_audio_path", "btnPlayOpdracht1Audio");
    wireAudioInput("opdracht2_audio_path", "btnPlayOpdracht2Audio");
    wireAudioInput("opdracht3_audio_path", "btnPlayOpdracht3Audio");
    wireAudioInput("opdracht4_audio_path", "btnPlayOpdracht4Audio");
    wireAudioInput("object3_audio_path", "btnPlayAudioObject3");
    wireAudioInput("opdracht5_audio_path", "btnPlayOpdracht5Audio");
    wireAudioInput("woord_audio_path", "btnPlayWoordAudio");
    wireAudioInput("object2_audio_path", "btnPlayAudioObject2");
    wireImagePreview("image1_preview");
    wireImagePreview("image2_preview");
    wireImagePreview("image3_preview");
    wireImagePreview("logoImage");
    $("logoImage").addEventListener("click", () => {
      playLogoAudio();
    });
    $("image1_path").addEventListener("input", () => updateImagePreview("image1_path", "image1_preview"));
    $("image2_path").addEventListener("input", () => updateImagePreview("image2_path", "image2_preview"));
    $("image3_path").addEventListener("input", () => updateImagePreview("image3_path", "image3_preview"));

    $("imageLightbox").addEventListener("click", (e) => {
      if (e.target.id === "imageLightbox" || e.target.id === "imageLightboxClose") {
        closeImageLightbox();
      }
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeImageLightbox();
    });

    // Upload buttons -> update db path fields

    // Link buttons (signed URLs)

    // Sounds
    // no add/refresh buttons in UI; keep loadSounds for selection changes

    // -----------------------------
    // Boot: restore from localStorage (optional convenience)
    // -----------------------------
    window.addEventListener("load", async () => {
      initFieldNameToggle();
      if (sbInitError) {
        msg($("authMsg"), `Supabase init failed: ${sbInitError.message || sbInitError}`, false);
        return;
      }
      // if user already has a session, refresh UI
      try {
        ensureClient();
        if (!authListenerBound) {
          sb.auth.onAuthStateChange((_event, session) => refreshAuthUI(session));
          authListenerBound = true;
        }
        await refreshAuthUI();
      } catch (_) {
        // no client yet (missing url/key) - ignore
      }
    });
  </script>
</body>
</html>
