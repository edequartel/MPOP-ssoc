<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MPOP++ editor - Bartiméus Onderwijs</title>

  <link id="appStyles" rel="stylesheet" href="styles.css" />
</head>

<body>
  <h1>MPOP++ editor - Bartiméus Onderwijs</h1>
  <!--
  <div class="muted">
    Single-file HTML editor for your Supabase tables <span class="mono">mpop_items</span> and <span class="mono">mpop_sounds</span>.
    Uses Supabase Auth + RLS as the security boundary.
  </div>
-->

  <div class="hr"></div>

  <div class="row">
    <!-- LEFT: Auth + List -->
    <div class="card">
      <h2 class="section-title">1 Log in</h2>
<!--
      <div class="tiny">Supabase config loaded from <span class="mono">/api/supabase-config</span>.</div>
    -->
      <div class="hr"></div>

      <div id="authLoggedOut">
        <label>Email</label>
        <input id="email" type="email" placeholder="name@school.nl" value="edequartel@bartimeus.nl" />

        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" value="zeemeeuw2015" />

        <div class="btnrow mt-10">
          <button id="btnSignIn">Sign in</button>
          <button id="btnSignUp">Sign up</button>
        </div>
        <div id="authMsg" class="tiny mt-10"></div>
      </div>

      <div id="authLoggedIn" class="hidden">
        <div class="kpi">
          <div class="pill">Signed in: <span id="userEmail" class="ok"></span></div>
          <div class="pill">Role: <span id="userRole" class="ok"></span></div>
        </div>
        <div class="btnrow mt-10">
          <button id="btnRefresh">Ververs lijst</button>
          <button id="btnSignOut">Log uit</button>
        </div>
        <div id="listMsg" class="tiny mt-10"></div>

        <div class="hr"></div>

        <h2 class="section-title">2 Kies item</h2>
        <label>Search</label>
        <input id="search" placeholder="type code/title (e.g., bal-001)" />

        <div class="list mt-8" id="itemsList"></div>
      </div>
    </div>

    <!-- RIGHT: Editor -->
    <div class="card">
      <h2 class="section-title">3 Wijzig item</h2>
      <div id="editorHint" class="muted">Log in en kies item om te wijzigen.</div>

      <div id="editor" class="hidden">
        <div class="kpi">
          <div class="pill">Code: <span id="code" class="ok mono"></span></div>
          <div class="pill">Status: <span id="status" class="ok mono"></span></div>
          <div class="pill">Version: <span id="version" class="ok mono"></span></div>
          <div class="pill">Updated: <span id="updatedAt" class="ok mono"></span></div>
        </div>
        <div class="btnrow mt-10">
        </div>
        <div id="saveMsg" class="tiny mt-10"></div>

        <label>Auteur</label>
        <input id="auteur" />

        <label>Titel</label>
        <input id="title" />

        <label>Status</label>
        <select id="statusSelect">
          <option value="draft">draft</option>
          <option value="in_review">in_review</option>
          <option value="approved">approved</option>
        </select>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 1</h2>

        <div class="split">
          <div>
            <label>Verhaal</label>
            <textarea id="story_text"></textarea>

            <div class="inlineRow">
              <input id="story_audio_path" placeholder="/sounds/nl/stories/bal-001.mp3" />
              <button id="btnPlayStoryAudio" disabled>Play</button>
            </div>
          </div>

          <div>
            <label>Object beschrijving</label>
            <textarea id="beschrijving_object"></textarea>

           <!-- <label>audio</label> -->
            
            <div class="inlineRow">
              <input id="audio_object" placeholder="/sounds/nl/objects/object.mp3" />
              <button id="btnPlayAudioObject" disabled>Play</button>
            </div>
          </div>
        </div>

        <div class="split">
          <div>
            <label>Afbeelding (path)</label>
            <input id="image1_path" placeholder="/resources/images/bal.png" data-preview-placeholder="true" />
            <img id="image1_preview" class="image-thumb" alt="image preview" />
          </div>
          <div>
            <label>Klankzuiver</label>
            <textarea id="klankzuiver_text"></textarea>

            <div class="inlineRow">
              <input id="klankzuiver_letters" placeholder="/sounds/nl/klankzuiver/klankzuiver.mp3" />
              <button id="btnPlayKlankzuiverAudio" disabled>Play</button>
            </div>

          </div>
        </div>

        <div class="split">
          <div>
            <label>Opdracht 1</label>
            <textarea id="opdracht1_text"></textarea>

            <div class="inlineRow">
              <input id="opdracht1_audio_path" placeholder="/sounds/nl/opdracht/opdracht1.mp3" />
              <button id="btnPlayOpdracht1Audio" disabled>Play</button>
            </div>
          </div>

          <div>
            <label>Opdracht 2</label>
            <textarea id="opdracht2_text"></textarea>

            <div class="inlineRow">
              <input id="opdracht2_audio_path" placeholder="/sounds/nl/opdracht/opdracht2.mp3" />
              <button id="btnPlayOpdracht2Audio" disabled>Play</button>
            </div>
          </div>
        </div>

        <label>Opmerkingen</label>
        <textarea id="remarks_1"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 2</h2>

        <div class="split">
          <div>
            <label>Berschrijving afbeelding</label>
            <textarea id="beschrijving_text"></textarea>

            <div class="inlineRow">
              <input id="beschrijving_audio_path" placeholder="/sounds/nl/beschrijving/beschrijving.mp3" />
              <button id="btnPlayBeschrijvingAudio" disabled>Play</button>
            </div>
          </div>
          <div>
            <label>Geluid</label>
            <input id="woord_text" />

            <div class="inlineRow">
              <input id="woord_audio_path" placeholder="/sounds/nl/woorden/woord.mp3" />
              <button id="btnPlayWoordAudio" disabled>Play</button>
            </div>
          </div>
        </div>

        <div class="list mt-10" id="soundsList"></div>
        <div id="soundsMsg" class="tiny mt-8"></div>

        <div class="split">
          <div>
            <label>Afbeelding actief (path)</label>
            <input id="image2_path" placeholder="/resources/images/bal.png" data-preview-placeholder="true" />
            <img id="image2_preview" class="image-thumb" alt="image preview" />
          </div>

          <div>
          </div>
        </div>

        <label>Tekst (optioneel)</label>
        <textarea id="text11"></textarea>

        <label>Opmerkingen</label>
        <textarea id="remarks_2"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 3</h2>

        <div class="split">
          <div>
            <label>Opdracht 3</label>
            <textarea id="opdracht3_text"></textarea>
            <div class="inlineRow">
              <input id="opdracht3_audio_path" placeholder="/sounds/nl/opdracht/opdracht3.mp3" />
              <button id="btnPlayOpdracht3Audio" disabled>Play</button>
            </div>
          </div>
          <div>
            <label>Opdracht 4</label>
            <textarea id="opdracht4_text"></textarea>
            <div class="inlineRow">
              <input id="opdracht4_audio_path" placeholder="/sounds/nl/opdracht/opdracht4.mp3" />
              <button id="btnPlayOpdracht4Audio" disabled>Play</button>
            </div>
          </div>
        </div>

        <label>Afbeelding 3 (path)</label>
        <input id="image3_path" placeholder="/resources/images/beeld3.png" />
        <img id="image3_preview" class="image-thumb" alt="image preview" />

        <div class="split">
          <div>
            <label>Opdracht 5</label>
            <textarea id="opdracht5_text"></textarea>
            <div class="inlineRow">
              <input id="opdracht5_audio_path" placeholder="/sounds/nl/opdracht/opdracht5.mp3" />
              <button id="btnPlayOpdracht5Audio" disabled>Play</button>
            </div>
          </div>
          <div>
            <label>Opdracht 6</label>
            <textarea id="opdracht6_text"></textarea>
            <div class="inlineRow">
              <input id="opdracht6_audio_path" placeholder="/sounds/nl/opdracht/opdracht6.mp3" />
              <button id="btnPlayOpdracht6Audio" disabled>Play</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 4</h2>

        <div class="split">
          <div>
            <label>Titel</label>
            <input id="page_a_title_letters" />
          </div>
          <div>
            <label>Titel (braille)</label>
            <input id="page_a_title_braille" readonly />
          </div>
        </div>

        <div class="split">
          <div>
            <label>Tekst</label>
            <textarea id="page_a_text"></textarea>
          </div>
          <div>
            <label>Tekst (braille)</label>
            <textarea id="page_a_text_braille" readonly></textarea>
          </div>
        </div>

        <label>Opmerkingen)</label>
        <textarea id="remarks_3"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 5</h2>

        <div class="split">
          <div>
            <label>Titel</label>
            <input id="page_b_title_letters" />
          </div>
          <div>
            <label>Titel (braille)</label>
            <input id="page_b_title_braille" readonly />
          </div>
        </div>

        <div class="split">
          <div>
            <label>Tekst</label>
            <textarea id="page_b_text"></textarea>
          </div>
          <div>
            <label>Tekst (braille)</label>
            <textarea id="page_b_text_braille" readonly></textarea>
          </div>
        </div>

        <label>Opmerkingen</label>
        <textarea id="remarks_4"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 6</h2>

        <div class="split">
          <div>
            <label>Titel</label>
            <input id="page_c_title_letters" />
          </div>
          <div>
            <label>Titel (braille)</label>
            <input id="page_c_title_braille" readonly />
          </div>
        </div>
        <div class="split">
          <div>
            <label>Tekst</label>
            <textarea id="page_c_text"></textarea>
          </div>
          <div>
            <label>Tekst (braille)</label>
            <textarea id="page_c_text_braille" readonly></textarea>
          </div>
        </div>

        <label>Opmerkingen</label>
        <textarea id="remarks_5"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 7</h2>
        <label>Handleiding</label>
        <textarea id="handleiding_text"></textarea>

        <label>Opmerkingen</label>
        <textarea id="remarks_6"></textarea>

        <div class="hr"></div>
        <h2 class="section-title pdf-page-break">Pagina 8</h2>

        <label>Materialen</label>
        <textarea id="materialen"></textarea>

        <div class="hr"></div>
      </div>
    </div>
  </div>

  <div id="imageLightbox" aria-hidden="true">
    <button id="imageLightboxClose" type="button">Close</button>
    <img id="imageLightboxImg" alt="image preview large" />
  </div>

  <script type="module">
    const $ = (id) => document.getElementById(id);
    const CONFIG_URL_LOCAL = "./supabase-config.js";
    const CONFIG_URL_REMOTE = "https://mpop-ssoc.vercel.app/api/supabase-config.js";

    const supabaseInit = async () => {
      try {
        let cfg = null;
        try {
          const mod = await import(CONFIG_URL_LOCAL);
          cfg = mod?.supabaseConfig || mod?.default || null;
          if (!cfg?.url || !cfg?.anonKey) {
            throw new Error("Local supabase-config.js missing url/anonKey.");
          }
        } catch (localErr) {
          const res = await fetch(CONFIG_URL_REMOTE);
          if (!res.ok) {
            const body = await res.text().catch(() => "");
            throw new Error(`Failed to load supabase-config (${res.status}). ${body}`.trim());
          }
          cfg = await res.json();
          if (!cfg?.url || !cfg?.anonKey) {
            throw new Error("Supabase config missing url/anonKey.");
          }
        }
        const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");
        return { client: createClient(cfg.url, cfg.anonKey), config: cfg, error: null };
      } catch (error) {
        console.error("Supabase init failed:", error);
        return { client: null, config: null, error };
      }
    };

    // -----------------------------
    // Supabase client + state
    // -----------------------------
    let sb = null;
    let currentItem = null; // full row from mpop_items
    let sounds = [];
    let authRefreshRunning = false;
    let authListenerBound = false;
    let isViewerRole = false;
    const audioPlayers = new Map();
    const AUDIO_ENDPOINT = "https://www.tastenbraille.com/braillestudio";
    const { client: sbClient, config: sbConfig, error: sbInitError } = await supabaseInit();
    sb = sbClient;
    // no UI display of config values

    function msg(el, text, ok=true) {
      el.innerHTML = text ? `<span class="${ok ? 'ok' : 'err'}">${escapeHtml(text)}</span>` : '';
    }
    function escapeHtml(s) {
      return (s ?? '').toString()
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }
    function formatDateTime(value) {
      if (!value) return "";
      const dt = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(dt.getTime())) return String(value);
      return dt.toLocaleString(undefined, {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }


    const BRAILLE_LETTERS = {
      a: "⠁", b: "⠃", c: "⠉", d: "⠙", e: "⠑", f: "⠋", g: "⠛", h: "⠓", i: "⠊", j: "⠚",
      k: "⠅", l: "⠇", m: "⠍", n: "⠝", o: "⠕", p: "⠏", q: "⠟", r: "⠗", s: "⠎", t: "⠞",
      u: "⠥", v: "⠧", w: "⠺", x: "⠭", y: "⠽", z: "⠵"
    };
    const BRAILLE_DIGITS = {
      "1": "⠁", "2": "⠃", "3": "⠉", "4": "⠙", "5": "⠑",
      "6": "⠋", "7": "⠛", "8": "⠓", "9": "⠊", "0": "⠚"
    };
    const BRAILLE_PUNCT = {
      ".": "⠲", ",": "⠂", ";": "⠆", ":": "⠒", "?": "⠦", "!": "⠖",
      "-": "⠤", "'": "⠄", "\"": "⠶", "(": "⠷", ")": "⠾", "/": "⠌"
    };

    function toBraille(text) {
      const s = (text ?? "").toString();
      let out = "";
      let inNumber = false;
      for (const ch of s) {
        if (ch >= "0" && ch <= "9") {
          if (!inNumber) {
            out += "⠼";
            inNumber = true;
          }
          out += BRAILLE_DIGITS[ch] || ch;
          continue;
        }
        if (inNumber) inNumber = false;
        if (ch === " " || ch === "\n" || ch === "\t") {
          out += ch;
          continue;
        }
        const lower = ch.toLowerCase();
        if (BRAILLE_LETTERS[lower]) {
          out += BRAILLE_LETTERS[lower];
          continue;
        }
        if (BRAILLE_PUNCT[ch]) {
          out += BRAILLE_PUNCT[ch];
          continue;
        }
        out += ch;
      }
      return out;
    }

    function updatePageBBraille() {
      $("page_b_title_braille").value = toBraille($("page_b_title_letters").value);
      $("page_b_text_braille").value = toBraille($("page_b_text").value);
    }

    function updatePageABraille() {
      $("page_a_title_braille").value = toBraille($("page_a_title_letters").value);
      $("page_a_text_braille").value = toBraille($("page_a_text").value);
    }

    function updatePageCBraille() {
      $("page_c_title_braille").value = toBraille($("page_c_title_letters").value);
      $("page_c_text_braille").value = toBraille($("page_c_text").value);
    }

    function setEditorReadonly(readonly) {
      for (const el of document.querySelectorAll("#editor input, #editor textarea, #editor select, #editor button")) {
        if (el.tagName === "BUTTON") {
          const btnId = el.id || "";
          if (btnId.startsWith("btnPlay") || el.classList.contains("btnSoundPlay")) {
            el.disabled = false;
            continue;
          }
        }
        el.disabled = readonly;
      }
    }

    function ensureClient() {
      if (sbInitError) {
        throw new Error(`Supabase init failed: ${sbInitError.message || sbInitError}`);
      }
      if (!sb) {
        throw new Error("Supabase client not ready.");
      }
      return sb;
    }

    // -----------------------------
    // Auth
    // -----------------------------
    async function refreshAuthUI(passedSession) {
      if (!sb || authRefreshRunning) return;
      authRefreshRunning = true;
      let session = passedSession ?? null;
      try {
        if (!session) {
          const { data } = await sb.auth.getSession();
          session = data?.session ?? null;
        }
      const loggedIn = !!session?.user;
      $("authLoggedOut").style.display = loggedIn ? "none" : "block";
      $("authLoggedIn").style.display  = loggedIn ? "block" : "none";

      if (loggedIn) {
        $("userEmail").textContent = session.user.email || "(no email)";

        // Fetch role from profiles (requires your RLS policy)
        const { data: prof, error } = await sb
          .from("profiles")
          .select("role, display_name")
          .eq("user_id", session.user.id)
          .maybeSingle();

        const role = error ? "unknown" : (prof?.role || "unknown");
        $("userRole").textContent = role;
        isViewerRole = role === "viewer";
        setEditorReadonly(isViewerRole);

        await loadItems();
      } else {
        $("itemsList").innerHTML = "";
        hideEditor();
        isViewerRole = false;
      }
      } finally {
        authRefreshRunning = false;
      }
    }

    async function signIn() {
      try {
        ensureClient();
        msg($("authMsg"), "");
        const email = $("email").value.trim();
        const password = $("password").value;
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        msg($("authMsg"), "Signed in.");
        await refreshAuthUI(data?.session ?? null);
      } catch (e) {
        msg($("authMsg"), e.message || String(e), false);
      }
    }

    async function signUp() {
      try {
        ensureClient();
        msg($("authMsg"), "");
        const email = $("email").value.trim();
        const password = $("password").value;
        const { error } = await sb.auth.signUp({ email, password });
        if (error) throw error;
        msg($("authMsg"), "Sign-up OK. If email confirmation is enabled, confirm your email before signing in.");
      } catch (e) {
        msg($("authMsg"), e.message || String(e), false);
      }
    }

    async function signOut() {
      try {
        msg($("listMsg"), "");
        await sb.auth.signOut();
        await refreshAuthUI();
      } catch (e) {
        msg($("listMsg"), e.message || String(e), false);
      }
    }

    // -----------------------------
    // Items list + selection
    // -----------------------------
    async function loadItems() {
      try {
        msg($("listMsg"), "Loading...");
        const { data, error } = await sb
          .from("mpop_items")
          .select("id, code, title, status, updated_at, version, sort_index")
          .order("sort_index", { ascending: true });

        if (error) throw error;

        renderItems(data || []);
        msg($("listMsg"), `Loaded ${data?.length || 0} items.`);
      } catch (e) {
        msg($("listMsg"), e.message || String(e), false);
      }
    }

    function renderItems(items) {
      const q = $("search").value.trim().toLowerCase();
      const filtered = !q ? items : items.filter(x =>
        (x.code || "").toLowerCase().includes(q) ||
        (x.title || "").toLowerCase().includes(q)
      );

      const host = $("itemsList");
      host.innerHTML = "";

      for (const it of filtered) {
        const b = document.createElement("button");
        b.className = "itembtn";
        const title = it.title || "(no title)";
        const status = it.status || "no status";
        b.textContent = `${title} (${status})`;
        b.onclick = () => selectItem(it.id);
        host.appendChild(b);
      }
    }

    async function selectItem(id) {
      try {
        msg($("saveMsg"), "");
        const { data, error } = await sb
          .from("mpop_items")
          .select("*")
          .eq("id", id)
          .single();
        if (error) throw error;

        currentItem = data;
        showEditor(data);
        await loadSounds();
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      }
    }

    function hideEditor() {
      $("editorHint").style.display = "block";
      $("editor").style.display = "none";
      currentItem = null;
    }

    let autosaveTimer = null;
    let autosaveRunning = false;

    function scheduleAutosave() {
      if (isViewerRole) return;
      if (!currentItem) return;
      if (autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(async () => {
        if (autosaveRunning || !currentItem) return;
        autosaveRunning = true;
        try {
          msg($("saveMsg"), "Autosaving...");
          await saveItem();
        } finally {
          autosaveRunning = false;
        }
      }, 1500);
    }

    function showEditor(row) {
      $("editorHint").style.display = "none";
      $("editor").style.display = "block";

      $("code").textContent = row.code || "";
      $("status").textContent = row.status || "";
      $("version").textContent = String(row.version ?? "");
      $("updatedAt").textContent = formatDateTime(row.updated_at);

      $("auteur").value = row.auteur || "";
      $("title").value = row.title || "";
      $("statusSelect").value = row.status || "draft";

      $("story_text").value = row.story_text || "";
      $("beschrijving_object").value = row.beschrijving_object || "";
      $("audio_object").value = row.audio_object || "";
      $("klankzuiver_text").value = row.klankzuiver_text || "";
      $("klankzuiver_letters").value = row.klankzuiver_audio_path || "";
      $("opdracht1_text").value = row.opdracht1_text || "";
      $("opdracht2_text").value = row.opdracht2_text || "";
      $("opdracht3_text").value = row.opdracht3_text || "";
      $("opdracht4_text").value = row.opdracht4_text || "";
      $("opdracht5_text").value = row.opdracht5_text || "";
      $("opdracht6_text").value = row.opdracht6_text || "";
      $("image3_path").value = row.image3_path || "";
      $("woord_text").value = row.woord_text || "";
      $("beschrijving_text").value = row.beschrijving_text || "";
      $("remarks_1").value = row.remarks_1 || "";
      $("text11").value = row.text11 || "";
      $("remarks_2").value = row.remarks_2 || "";
      $("page_a_title_letters").value = row.page_a_title_letters || "";
      $("page_a_text").value = row.page_a_text || "";
      updatePageABraille();
      $("remarks_3").value = row.remarks_3 || "";
      $("page_b_title_letters").value = row.page_b_title_letters || "";
      $("page_b_text").value = row.page_b_text || "";
      updatePageBBraille();
      $("remarks_4").value = row.remarks_4 || "";
      $("page_c_title_letters").value = row.page_c_title_letters || "";
      $("page_c_text").value = row.page_c_text || "";
      updatePageCBraille();
      $("remarks_5").value = row.remarks_5 || "";
      $("handleiding_text").value = row.handleiding_text || "";
      $("remarks_6").value = row.remarks_6 || "";
      $("materialen").value = row.materialen || "";

      // paths
      $("story_audio_path").value = row.story_audio_path || "";
      $("opdracht1_audio_path").value = row.opdracht1_audio_path || "";
      $("opdracht2_audio_path").value = row.opdracht2_audio_path || "";
      $("opdracht3_audio_path").value = row.opdracht3_audio_path || "";
      $("opdracht4_audio_path").value = row.opdracht4_audio_path || "";
      $("opdracht5_audio_path").value = row.opdracht5_audio_path || "";
      $("opdracht6_audio_path").value = row.opdracht6_audio_path || "";
      $("woord_audio_path").value = row.woord_audio_path || "";
      $("beschrijving_audio_path").value = row.beschrijving_audio_path || "";
      $("image1_path").value = row.image1_path || "";
      $("image2_path").value = row.image2_path || "";
      $("image3_path").value = row.image3_path || "";

      setPlayButton("btnPlayStoryAudio", $("story_audio_path").value);
      setPlayButton("btnPlayAudioObject", $("audio_object").value);
      setPlayButton("btnPlayOpdracht1Audio", $("opdracht1_audio_path").value);
      setPlayButton("btnPlayOpdracht2Audio", $("opdracht2_audio_path").value);
      setPlayButton("btnPlayOpdracht3Audio", $("opdracht3_audio_path").value);
      setPlayButton("btnPlayOpdracht4Audio", $("opdracht4_audio_path").value);
      setPlayButton("btnPlayOpdracht5Audio", $("opdracht5_audio_path").value);
      setPlayButton("btnPlayOpdracht6Audio", $("opdracht6_audio_path").value);
      setPlayButton("btnPlayWoordAudio", $("woord_audio_path").value);
      setPlayButton("btnPlayBeschrijvingAudio", $("beschrijving_audio_path").value);
      setPlayButton("btnPlayKlankzuiverAudio", $("klankzuiver_letters").value);
      updateImagePreview("image1_path", "image1_preview");
      updateImagePreview("image2_path", "image2_preview");
      updateImagePreview("image3_path", "image3_preview");

    }

    // -----------------------------
    // Save (optimistic concurrency via version)
    // -----------------------------
    async function saveItem() {
      if (!currentItem) return;
      try {
        msg($("saveMsg"), "Saving...");
        const payload = {
          auteur: $("auteur").value.trim(),
          title: $("title").value.trim(),
          status: $("statusSelect").value,

          story_text: $("story_text").value,
          beschrijving_object: $("beschrijving_object").value.trim(),
          audio_object: $("audio_object").value.trim(),
          klankzuiver_text: $("klankzuiver_text").value,
          klankzuiver_audio_path: $("klankzuiver_letters").value.trim(),

          opdracht1_text: $("opdracht1_text").value,
          opdracht2_text: $("opdracht2_text").value,
          opdracht3_text: $("opdracht3_text").value,
          opdracht4_text: $("opdracht4_text").value,
          opdracht5_text: $("opdracht5_text").value,
          opdracht6_text: $("opdracht6_text").value,

          woord_text: $("woord_text").value,

          beschrijving_text: $("beschrijving_text").value,

          story_audio_path: $("story_audio_path").value.trim(),
          opdracht1_audio_path: $("opdracht1_audio_path").value.trim(),
          opdracht2_audio_path: $("opdracht2_audio_path").value.trim(),
          opdracht3_audio_path: $("opdracht3_audio_path").value.trim(),
          opdracht4_audio_path: $("opdracht4_audio_path").value.trim(),
          opdracht5_audio_path: $("opdracht5_audio_path").value.trim(),
          opdracht6_audio_path: $("opdracht6_audio_path").value.trim(),
          woord_audio_path: $("woord_audio_path").value.trim(),
          beschrijving_audio_path: $("beschrijving_audio_path").value.trim(),
          image1_path: $("image1_path").value.trim(),
          image2_path: $("image2_path").value.trim(),
          image3_path: $("image3_path").value.trim(),

          remarks_1: $("remarks_1").value,

          text11: $("text11").value,
          remarks_2: $("remarks_2").value,

          page_a_title_letters: $("page_a_title_letters").value,
          page_a_text: $("page_a_text").value,
          remarks_3: $("remarks_3").value,

          page_b_title_letters: $("page_b_title_letters").value,
          page_b_text: $("page_b_text").value,
          remarks_4: $("remarks_4").value,

          page_c_title_letters: $("page_c_title_letters").value,
          page_c_text: $("page_c_text").value,
          remarks_5: $("remarks_5").value,

          handleiding_text: $("handleiding_text").value,
          remarks_6: $("remarks_6").value,
          materialen: $("materialen").value
        };

        // Only update if version matches what we loaded
        const { data, error } = await sb
          .from("mpop_items")
          .update(payload)
          .eq("id", currentItem.id)
          .eq("version", currentItem.version)
          .select("*")
          .maybeSingle();

        if (error) throw error;

        if (!data) {
          throw new Error("Conflict: the item was updated by someone else. Click Reload item and retry.");
        }

        currentItem = data;
        showEditor(data);
        msg($("saveMsg"), "Saved.");
        await loadItems();
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      }
    }

    async function reloadItem() {
      if (!currentItem) return;
      await selectItem(currentItem.id);
      msg($("saveMsg"), "Reloaded.");
    }

    // -----------------------------
    // Audio playback (endpoint + path)
    // -----------------------------
    function buildAudioUrl(path) {
      const trimmed = (path || "").trim();
      if (!trimmed) return "";
      if (trimmed.startsWith("http://") || trimmed.startsWith("https://")) {
        return trimmed;
      }
      const base = AUDIO_ENDPOINT.replace(/\/+$/,"");
      const suffix = trimmed.startsWith("/") ? trimmed : "/" + trimmed;
      return base + suffix;
    }

    function buildImageUrl(path) {
      return buildAudioUrl(path);
    }

    function updateImagePreview(inputId, imgId) {
      const img = $(imgId);
      const input = $(inputId);
      const path = (input.value || "").trim();
      const url = buildImageUrl(path);
      if (!url) {
        img.style.display = "none";
        img.removeAttribute("src");
        img.removeAttribute("data-full-url");
        return;
      }
      img.src = url;
      img.dataset.fullUrl = url;
      img.style.display = "block";
    }

    function openImageLightbox(url, altText) {
      const lightbox = $("imageLightbox");
      const lightboxImg = $("imageLightboxImg");
      if (!url) return;
      lightboxImg.src = url;
      lightboxImg.alt = altText || "image preview large";
      lightbox.style.display = "flex";
      lightbox.setAttribute("aria-hidden", "false");
    }

    function closeImageLightbox() {
      const lightbox = $("imageLightbox");
      const lightboxImg = $("imageLightboxImg");
      lightbox.style.display = "none";
      lightbox.setAttribute("aria-hidden", "true");
      lightboxImg.removeAttribute("src");
    }

    function wireImagePreview(imgId) {
      const img = $(imgId);
      img.addEventListener("click", () => {
        const url = img.dataset.fullUrl || img.getAttribute("src");
        if (url) openImageLightbox(url, img.alt);
      });
    }

    function setPlayButton(btnId, path) {
      const btn = $(btnId);
      btn.disabled = !path || !path.trim();
      btn.textContent = "Play";
    }

    function wireAudioInput(inputId, btnId) {
      const input = $(inputId);
      input.addEventListener("input", () => setPlayButton(btnId, input.value));
    }

    function toggleAudio(btn, path) {
      const url = buildAudioUrl(path);
      if (!url) throw new Error("No audio path saved for this field yet.");
      let player = audioPlayers.get(url);
      if (!player) {
        player = new Audio(url);
        audioPlayers.set(url, player);
        player.addEventListener("ended", () => { btn.textContent = "Play"; });
      }
      if (!player.paused) {
        player.pause();
        btn.textContent = "Play";
        return;
      }
      for (const [otherUrl, otherPlayer] of audioPlayers.entries()) {
        if (otherUrl !== url && !otherPlayer.paused) {
          otherPlayer.pause();
          otherPlayer.currentTime = 0;
        }
      }
      for (const otherBtn of document.querySelectorAll("button[id^='btnPlay'], .btnSoundPlay")) {
        if (otherBtn !== btn) otherBtn.textContent = "Play";
      }
      btn.textContent = "Pause";
      player.play();
    }

    // -----------------------------
    // Storage helpers (upload + signed links)
    // -----------------------------
    function mustHaveCode() {
      const code = (currentItem?.code || "").trim();
      if (!code) throw new Error("This item has no code. Set code in the database (mpop_items.code).");
      return code;
    }

    async function uploadToBucket(bucket, path, file) {
      const { error } = await sb.storage.from(bucket).upload(path, file, { upsert: true });
      if (error) throw error;
      return path;
    }

    async function signedLink(bucket, path, expiresSeconds = 3600) {
      const { data, error } = await sb.storage.from(bucket).createSignedUrl(path, expiresSeconds);
      if (error) throw error;
      return data.signedUrl;
    }

    async function uploadAndSetField({ bucket, fileInputId, dbField, defaultName }) {
      if (!currentItem) return;
      const code = mustHaveCode();
      const file = $(fileInputId).files?.[0];
      if (!file) throw new Error("Select a file first.");
      const ext = (file.name.split(".").pop() || "").toLowerCase();
      const safeExt = ext ? "." + ext : "";
      const path = `${code}/${defaultName}${safeExt}`;

      await uploadToBucket(bucket, path, file);

      // Update only the path field; still protect with version
      const payload = {};
      payload[dbField] = path;

      const { data, error } = await sb
        .from("mpop_items")
        .update(payload)
        .eq("id", currentItem.id)
        .eq("version", currentItem.version)
        .select("*")
        .maybeSingle();

      if (error) throw error;
      if (!data) throw new Error("Conflict while saving the file path. Reload item and retry.");

      currentItem = data;
      showEditor(data);
      await loadItems();
      return path;
    }

    async function linkForField({ bucket, dbField, outElId }) {
      if (!currentItem) return;
      const path = currentItem[dbField];
      if (!path) throw new Error("No file path saved for this field yet.");
      const url = await signedLink(bucket, path, 3600);
      $(outElId).innerHTML = `<a href="${url}" target="_blank" rel="noreferrer">Open (valid 1 hour)</a>`;
    }

    // -----------------------------
    // Sounds (mpop_sounds)
    // -----------------------------
    async function loadSounds() {
      if (!currentItem) return;
      const { data, error } = await sb
        .from("mpop_sounds")
        .select("id, label, audio_path, sort_order")
        .eq("mpop_item_id", currentItem.id)
        .order("sort_order", { ascending: true });

      if (error) {
        msg($("soundsMsg"), error.message, false);
        return;
      }

      sounds = data || [];
      renderSounds();
        msg($("soundsMsg"), "");
    }

    function renderSounds() {
      const host = $("soundsList");
      host.innerHTML = "";

      if (!sounds.length) return;

      for (const s of sounds) {
        const wrap = document.createElement("div");
        wrap.className = "card";
        wrap.style.padding = "10px";
        wrap.innerHTML = `
          <div class="kpi">
            <div class="pill">Label: <span class="ok mono">${escapeHtml(s.label || "")}</span></div>
            <div class="pill">Order: <span class="ok mono">${escapeHtml(String(s.sort_order ?? 0))}</span></div>
          </div>
          <label class="mt-8">Audio path (audio_path)</label>
          <div class="inlineRow">
            <input value="${escapeHtml(s.audio_path || "")}" readonly />
            <button data-id="${s.id}" class="btnSoundPlay" ${s.audio_path ? "" : "disabled"}>Play</button>
          </div>
        `;
        host.appendChild(wrap);
      }

      for (const btn of document.querySelectorAll(".btnSoundPlay")) {
        btn.onclick = async () => {
          try {
            const id = btn.getAttribute("data-id");
            const sound = sounds.find(x => x.id === id);
            if (!sound?.audio_path) throw new Error("No audio_path.");
            toggleAudio(btn, sound.audio_path);
          } catch (e) {
            msg($("soundsMsg"), e.message || String(e), false);
          }
        };
      }
    }

    // -----------------------------
    // Wire up buttons
    // -----------------------------
    $("btnSignIn").onclick = signIn;
    $("btnSignUp").onclick = signUp;

    $("btnSignOut").onclick = signOut;
    $("btnRefresh").onclick = () => loadItems();

    $("search").addEventListener("input", async () => {
      // re-render from last loaded list by reloading quickly:
      // simplest: just reload items; if you prefer client-side filtering only, store items list.
      await loadItems();
    });


    for (const el of document.querySelectorAll("#editor input, #editor textarea, #editor select")) {
      el.addEventListener("input", scheduleAutosave);
      el.addEventListener("change", scheduleAutosave);
    }

    $("page_b_title_letters").addEventListener("input", updatePageBBraille);
    $("page_b_text").addEventListener("input", updatePageBBraille);
    $("page_a_title_letters").addEventListener("input", updatePageABraille);
    $("page_a_text").addEventListener("input", updatePageABraille);
    $("page_c_title_letters").addEventListener("input", updatePageCBraille);
    $("page_c_text").addEventListener("input", updatePageCBraille);

    $("btnPlayStoryAudio").onclick = () => {
      try { toggleAudio($("btnPlayStoryAudio"), $("story_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayAudioObject").onclick = () => {
      try { toggleAudio($("btnPlayAudioObject"), $("audio_object").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayKlankzuiverAudio").onclick = () => {
      try { toggleAudio($("btnPlayKlankzuiverAudio"), $("klankzuiver_letters").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht1Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht1Audio"), $("opdracht1_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht2Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht2Audio"), $("opdracht2_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht3Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht3Audio"), $("opdracht3_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht4Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht4Audio"), $("opdracht4_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht5Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht5Audio"), $("opdracht5_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht6Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht6Audio"), $("opdracht6_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayWoordAudio").onclick = () => {
      try { toggleAudio($("btnPlayWoordAudio"), $("woord_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayBeschrijvingAudio").onclick = () => {
      try { toggleAudio($("btnPlayBeschrijvingAudio"), $("beschrijving_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };

    wireAudioInput("story_audio_path", "btnPlayStoryAudio");
    wireAudioInput("audio_object", "btnPlayAudioObject");
    wireAudioInput("klankzuiver_letters", "btnPlayKlankzuiverAudio");
    wireAudioInput("opdracht1_audio_path", "btnPlayOpdracht1Audio");
    wireAudioInput("opdracht2_audio_path", "btnPlayOpdracht2Audio");
    wireAudioInput("opdracht3_audio_path", "btnPlayOpdracht3Audio");
    wireAudioInput("opdracht4_audio_path", "btnPlayOpdracht4Audio");
    wireAudioInput("opdracht5_audio_path", "btnPlayOpdracht5Audio");
    wireAudioInput("opdracht6_audio_path", "btnPlayOpdracht6Audio");
    wireAudioInput("woord_audio_path", "btnPlayWoordAudio");
    wireAudioInput("beschrijving_audio_path", "btnPlayBeschrijvingAudio");
    wireImagePreview("image1_preview");
    wireImagePreview("image2_preview");
    wireImagePreview("image3_preview");
    $("image1_path").addEventListener("input", () => updateImagePreview("image1_path", "image1_preview"));
    $("image2_path").addEventListener("input", () => updateImagePreview("image2_path", "image2_preview"));
    $("image3_path").addEventListener("input", () => updateImagePreview("image3_path", "image3_preview"));

    $("imageLightbox").addEventListener("click", (e) => {
      if (e.target.id === "imageLightbox" || e.target.id === "imageLightboxClose") {
        closeImageLightbox();
      }
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeImageLightbox();
    });

    // Upload buttons -> update db path fields

    // Link buttons (signed URLs)

    // Sounds
    // no add/refresh buttons in UI; keep loadSounds for selection changes

    // -----------------------------
    // Boot: restore from localStorage (optional convenience)
    // -----------------------------
    window.addEventListener("load", async () => {
      if (sbInitError) {
        msg($("authMsg"), `Supabase init failed: ${sbInitError.message || sbInitError}`, false);
        return;
      }
      // if user already has a session, refresh UI
      try {
        ensureClient();
        if (!authListenerBound) {
          sb.auth.onAuthStateChange((_event, session) => refreshAuthUI(session));
          authListenerBound = true;
        }
        await refreshAuthUI();
      } catch (_) {
        // no client yet (missing url/key) - ignore
      }
    });
  </script>
</body>
</html>
