<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>mPOP SSoC Editor (Supabase)</title>

  <!-- Supabase JS via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { --bg:#0b0e14; --fg:#e9effa; --muted:#a9b6c8; --card:#121826; --line:rgba(255,255,255,.12); }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--fg); margin:16px; }
    h1 { font-size:20px; margin:0 0 10px; }
    .row { display:grid; grid-template-columns: 360px 1fr; gap:12px; align-items:start; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .muted { color:var(--muted); font-size:13px; line-height:1.4; }
    label { display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }
    input, textarea, select, button {
      width:100%;
      box-sizing:border-box;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--fg);
      padding:10px;
      font-size:14px;
    }
    textarea { min-height:80px; resize:vertical; }
    button { cursor:pointer; background: rgba(255,255,255,.08); }
    button:hover { background: rgba(255,255,255,.12); }
    .btnrow { display:flex; gap:8px; flex-wrap:wrap; }
    .btnrow button { width:auto; padding:10px 12px; }
    .inlineRow { display:flex; gap:8px; align-items:center; }
    .inlineRow input { flex:1; }
    .inlineRow button { width:auto; padding:8px 10px; }
    .list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .itembtn { text-align:left; }
    .split { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .kpi { display:flex; gap:10px; flex-wrap:wrap; }
    .pill { border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); }
    .ok { color:#b7f7c1; }
    .err { color:#ffb4b4; }
    .hr { height:1px; background:var(--line); margin:10px 0; }
    .tiny { font-size:12px; color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <h1>mPOP SSoC Editor</h1>
  <div class="muted">
    Single-file HTML editor for your Supabase tables <span class="mono">mpop_items</span> and <span class="mono">mpop_sounds</span>.
    Uses Supabase Auth + RLS as the security boundary.
  </div>

  <div class="hr"></div>

  <div class="row">
    <!-- LEFT: Auth + List -->
    <div class="card">
      <h2 style="margin:0 0 8px; font-size:16px;">1) Connect & Sign in</h2>

      <label>Supabase URL</label>
      <input id="sbUrl" placeholder="https://xxxx.supabase.co" />

      <label>Supabase anon key</label>
      <textarea id="sbAnon" placeholder="Your publishable/anon key"></textarea>

      <div class="hr"></div>

      <div id="authLoggedOut">
        <label>Email</label>
        <input id="email" type="email" placeholder="name@school.nl" />

        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" />

        <div class="btnrow" style="margin-top:10px;">
          <button id="btnSignIn">Sign in</button>
          <button id="btnSignUp">Sign up</button>
        </div>
        <div id="authMsg" class="tiny" style="margin-top:10px;"></div>
      </div>

      <div id="authLoggedIn" style="display:none;">
        <div class="kpi">
          <div class="pill">Signed in: <span id="userEmail" class="ok"></span></div>
          <div class="pill">Role: <span id="userRole" class="ok"></span></div>
        </div>
        <div class="btnrow" style="margin-top:10px;">
          <button id="btnRefresh">Refresh list</button>
          <button id="btnSignOut">Sign out</button>
        </div>
        <div id="listMsg" class="tiny" style="margin-top:10px;"></div>

        <div class="hr"></div>

        <h2 style="margin:0 0 8px; font-size:16px;">2) Select an mPOP item</h2>
        <label>Search</label>
        <input id="search" placeholder="type code/title (e.g., bal-001)" />

        <div class="list" id="itemsList"></div>
      </div>
    </div>

    <!-- RIGHT: Editor -->
    <div class="card">
      <h2 style="margin:0 0 8px; font-size:16px;">3) Edit item</h2>
      <div id="editorHint" class="muted">Sign in and select an item to edit.</div>

      <div id="editor" style="display:none;">
        <div class="kpi">
          <div class="pill">Code: <span id="code" class="ok mono"></span></div>
          <div class="pill">Status: <span id="status" class="ok mono"></span></div>
          <div class="pill">Version: <span id="version" class="ok mono"></span></div>
          <div class="pill">Updated: <span id="updatedAt" class="ok mono"></span></div>
        </div>
        <div class="btnrow" style="margin-top:10px;">
          <button id="btnSave">Save changes</button>
          <button id="btnReload">Reload item</button>
        </div>
        <div id="saveMsg" class="tiny" style="margin-top:10px;"></div>

        <label>Title (title)</label>
        <input id="title" />

        <label>Status (status)</label>
        <select id="statusSelect">
          <option value="draft">draft</option>
          <option value="in_review">in_review</option>
          <option value="approved">approved</option>
        </select>

        <div class="hr"></div>
        <h2 style="margin:0 0 8px; font-size:16px;">Page 1</h2>

        <div class="split">
          <div>
            <label>1a verhaal tekst (story_text)</label>
            <textarea id="story_text"></textarea>

            <label>1b verhaal audio path (story_audio_path)</label>
            <div class="inlineRow">
              <input id="story_audio_path" placeholder="/sounds/nl/stories/bal-001.mp3" />
              <button id="btnPlayStoryAudio" disabled>Play</button>
            </div>
          </div>

          <div>
            <label>Beschrijving object (beschrijving_object)</label>
            <textarea id="beschrijving_object"></textarea>

            <label>Audio object path (audio_object)</label>
            <div class="inlineRow">
              <input id="audio_object" placeholder="/sounds/nl/objects/object.mp3" />
              <button id="btnPlayAudioObject" disabled>Play</button>
            </div>
          </div>
        </div>

        <div class="split">
          <div>
            <label>7 afbeelding path (image1_path)</label>
            <input id="image1_path" placeholder="/resources/images/bal.png" />
            <img id="image1_preview" alt="image preview" style="display:none; max-width:100%; border-radius:8px; margin-top:8px; border:1px solid var(--line);" />
          </div>
          <div>
            <label>2a klankzuiver (klankzuiver_text)</label>
            <textarea id="klankzuiver_text"></textarea>

            <label>2a klankzuiver audio path (klankzuiver_audio_path)</label>
            <div class="inlineRow">
              <input id="klankzuiver_letters" placeholder="/sounds/nl/klankzuiver/klankzuiver.mp3" />
              <button id="btnPlayKlankzuiverAudio" disabled>Play</button>
            </div>

          </div>
        </div>

        <div class="split">
          <div>
            <label>3a opdracht tekst (opdracht1_text)</label>
            <textarea id="opdracht1_text"></textarea>

            <label>3b opdracht audio path (opdracht1_audio_path)</label>
            <div class="inlineRow">
              <input id="opdracht1_audio_path" placeholder="/sounds/nl/opdracht/opdracht1.mp3" />
              <button id="btnPlayOpdracht1Audio" disabled>Play</button>
            </div>
          </div>

          <div>
            <label>4a opdracht tekst (opdracht2_text)</label>
            <textarea id="opdracht2_text"></textarea>

            <label>4b opdracht audio path (opdracht2_audio_path)</label>
            <div class="inlineRow">
              <input id="opdracht2_audio_path" placeholder="/sounds/nl/opdracht/opdracht2.mp3" />
              <button id="btnPlayOpdracht2Audio" disabled>Play</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <h2 style="margin:0 0 8px; font-size:16px;">Page 2</h2>

        <div class="split">
          <div>
            <label>8a beschrijving tekst (beschrijving_text)</label>
            <textarea id="beschrijving_text"></textarea>

            <label>8b beschrijving audio path (beschrijving_audio_path)</label>
            <div class="inlineRow">
              <input id="beschrijving_audio_path" placeholder="/sounds/nl/beschrijving/beschrijving.mp3" />
              <button id="btnPlayBeschrijvingAudio" disabled>Play</button>
            </div>
          </div>
          <div>
            <label>6a woord tekst (woord_text)</label>
            <input id="woord_text" />

            <label>6b woord audio path (woord_audio_path)</label>
            <div class="inlineRow">
              <input id="woord_audio_path" placeholder="/sounds/nl/woorden/woord.mp3" />
              <button id="btnPlayWoordAudio" disabled>Play</button>
            </div>
          </div>
        </div>

        <div class="list" id="soundsList" style="margin-top:10px;"></div>
        <div id="soundsMsg" class="tiny" style="margin-top:8px;"></div>

        <div class="split">
          <div>
            <label>10 afbeelding (image2_path)</label>
            <input id="image2_path" placeholder="/resources/images/bal.png" />
            <img id="image2_preview" alt="image preview" style="display:none; max-width:100%; border-radius:8px; margin-top:8px; border:1px solid var(--line);" />
          </div>

          <div>
          </div>
        </div>

        <label>11 tekst (text11)</label>
        <textarea id="text11"></textarea>

        <div class="hr"></div>
        <h2 style="margin:0 0 8px; font-size:16px;">Page 3</h2>

        <div class="split">
          <div>
            <label>12 blz A titel woord letters (page_a_title_letters)</label>
            <input id="page_a_title_letters" />
            <label>13 blz A tekst (page_a_text)</label>
            <textarea id="page_a_text"></textarea>
          </div>
          <div></div>
        </div>

        <div class="hr"></div>
        <h2 style="margin:0 0 8px; font-size:16px;">Page 4</h2>

        <label>14 blz B titel woord letters (page_b_title_letters)</label>
        <input id="page_b_title_letters" />

        <label>15 blz B tekst (page_b_text)</label>
        <textarea id="page_b_text"></textarea>

        <div class="hr"></div>
        <h2 style="margin:0 0 8px; font-size:16px;">Page 5</h2>

        <div class="split">
          <div>
            <label>16 blz C titel woord letters (page_c_title_letters)</label>
            <input id="page_c_title_letters" />
          </div>
          <div></div>
        </div>
        <label>17 blz C tekst (page_c_text)</label>
        <textarea id="page_c_text"></textarea>

        <div class="hr"></div>
        <h2 style="margin:0 0 8px; font-size:16px;">Page 6</h2>

        <label>18 handleiding (handleiding_text)</label>
        <textarea id="handleiding_text"></textarea>

        <div class="hr"></div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Supabase client + state
    // -----------------------------
    let sb = null;
    let currentItem = null; // full row from mpop_items
    let sounds = [];
    let sbConfigKey = "";
    let authRefreshRunning = false;
    let authListenerBound = false;
    const audioPlayers = new Map();
    const AUDIO_ENDPOINT = "https://www.tastenbraille.com/braillestudio";

    const $ = (id) => document.getElementById(id);

    function msg(el, text, ok=true) {
      el.innerHTML = text ? `<span class="${ok ? 'ok' : 'err'}">${escapeHtml(text)}</span>` : '';
    }
    function escapeHtml(s) {
      return (s ?? '').toString()
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }

    function ensureClient() {
      const url = $("sbUrl").value.trim();
      const key = $("sbAnon").value.trim();
      if (!url || !key) throw new Error("Please provide Supabase URL and anon key.");
      if (!window.supabase || !window.supabase.createClient) {
        throw new Error("Supabase JS not loaded. Check the CDN script tag.");
      }
      const nextKey = `${url}::${key}`;
      if (!sb || sbConfigKey !== nextKey) {
        sb = window.supabase.createClient(url, key);
        sbConfigKey = nextKey;
        authListenerBound = false;
      }
      return sb;
    }

    // -----------------------------
    // Auth
    // -----------------------------
    async function refreshAuthUI(passedSession) {
      if (!sb || authRefreshRunning) return;
      authRefreshRunning = true;
      let session = passedSession ?? null;
      try {
        if (!session) {
          const { data } = await sb.auth.getSession();
          session = data?.session ?? null;
        }
      const loggedIn = !!session?.user;
      $("authLoggedOut").style.display = loggedIn ? "none" : "block";
      $("authLoggedIn").style.display  = loggedIn ? "block" : "none";

      if (loggedIn) {
        $("userEmail").textContent = session.user.email || "(no email)";

        // Fetch role from profiles (requires your RLS policy)
        const { data: prof, error } = await sb
          .from("profiles")
          .select("role, display_name")
          .eq("user_id", session.user.id)
          .maybeSingle();

        $("userRole").textContent = error ? "unknown" : (prof?.role || "unknown");

        await loadItems();
      } else {
        $("itemsList").innerHTML = "";
        hideEditor();
      }
      } finally {
        authRefreshRunning = false;
      }
    }

    async function signIn() {
      try {
        ensureClient();
        msg($("authMsg"), "");
        const email = $("email").value.trim();
        const password = $("password").value;
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        msg($("authMsg"), "Signed in.");
        await refreshAuthUI(data?.session ?? null);
      } catch (e) {
        msg($("authMsg"), e.message || String(e), false);
      }
    }

    async function signUp() {
      try {
        ensureClient();
        msg($("authMsg"), "");
        const email = $("email").value.trim();
        const password = $("password").value;
        const { error } = await sb.auth.signUp({ email, password });
        if (error) throw error;
        msg($("authMsg"), "Sign-up OK. If email confirmation is enabled, confirm your email before signing in.");
      } catch (e) {
        msg($("authMsg"), e.message || String(e), false);
      }
    }

    async function signOut() {
      try {
        msg($("listMsg"), "");
        await sb.auth.signOut();
        await refreshAuthUI();
      } catch (e) {
        msg($("listMsg"), e.message || String(e), false);
      }
    }

    // -----------------------------
    // Items list + selection
    // -----------------------------
    async function loadItems() {
      try {
        msg($("listMsg"), "Loading...");
        const { data, error } = await sb
          .from("mpop_items")
          .select("id, code, title, status, updated_at, version, sort_index")
          .order("sort_index", { ascending: true });

        if (error) throw error;

        renderItems(data || []);
        msg($("listMsg"), `Loaded ${data?.length || 0} items.`);
      } catch (e) {
        msg($("listMsg"), e.message || String(e), false);
      }
    }

    function renderItems(items) {
      const q = $("search").value.trim().toLowerCase();
      const filtered = !q ? items : items.filter(x =>
        (x.code || "").toLowerCase().includes(q) ||
        (x.title || "").toLowerCase().includes(q)
      );

      const host = $("itemsList");
      host.innerHTML = "";

      for (const it of filtered) {
        const b = document.createElement("button");
        b.className = "itembtn";
        b.textContent = `${it.code || "(no code)"} — ${it.title || ""} [${it.status}]`;
        b.onclick = () => selectItem(it.id);
        host.appendChild(b);
      }
    }

    async function selectItem(id) {
      try {
        msg($("saveMsg"), "");
        const { data, error } = await sb
          .from("mpop_items")
          .select("*")
          .eq("id", id)
          .single();
        if (error) throw error;

        currentItem = data;
        showEditor(data);
        await loadSounds();
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      }
    }

    function hideEditor() {
      $("editorHint").style.display = "block";
      $("editor").style.display = "none";
      currentItem = null;
    }

    function showEditor(row) {
      $("editorHint").style.display = "none";
      $("editor").style.display = "block";

      $("code").textContent = row.code || "";
      $("status").textContent = row.status || "";
      $("version").textContent = String(row.version ?? "");
      $("updatedAt").textContent = row.updated_at || "";

      $("title").value = row.title || "";
      $("statusSelect").value = row.status || "draft";

      $("story_text").value = row.story_text || "";
      $("beschrijving_object").value = row.beschrijving_object || "";
      $("audio_object").value = row.audio_object || "";
      $("klankzuiver_text").value = row.klankzuiver_text || "";
      $("klankzuiver_letters").value = row.klankzuiver_audio_path || "";
      $("opdracht1_text").value = row.opdracht1_text || "";
      $("opdracht2_text").value = row.opdracht2_text || "";
      $("woord_text").value = row.woord_text || "";
      $("beschrijving_text").value = row.beschrijving_text || "";
      $("text11").value = row.text11 || "";
      $("page_a_title_letters").value = row.page_a_title_letters || "";
      $("page_a_text").value = row.page_a_text || "";
      $("page_b_title_letters").value = row.page_b_title_letters || "";
      $("page_b_text").value = row.page_b_text || "";
      $("page_c_title_letters").value = row.page_c_title_letters || "";
      $("page_c_text").value = row.page_c_text || "";
      $("handleiding_text").value = row.handleiding_text || "";

      // paths
      $("story_audio_path").value = row.story_audio_path || "";
      $("opdracht1_audio_path").value = row.opdracht1_audio_path || "";
      $("opdracht2_audio_path").value = row.opdracht2_audio_path || "";
      $("woord_audio_path").value = row.woord_audio_path || "";
      $("beschrijving_audio_path").value = row.beschrijving_audio_path || "";
      $("image1_path").value = row.image1_path || "";
      $("image2_path").value = row.image2_path || "";

      setPlayButton("btnPlayStoryAudio", $("story_audio_path").value);
      setPlayButton("btnPlayAudioObject", $("audio_object").value);
      setPlayButton("btnPlayOpdracht1Audio", $("opdracht1_audio_path").value);
      setPlayButton("btnPlayOpdracht2Audio", $("opdracht2_audio_path").value);
      setPlayButton("btnPlayWoordAudio", $("woord_audio_path").value);
      setPlayButton("btnPlayBeschrijvingAudio", $("beschrijving_audio_path").value);
      setPlayButton("btnPlayKlankzuiverAudio", $("klankzuiver_letters").value);
      updateImagePreview("image1_path", "image1_preview");
      updateImagePreview("image2_path", "image2_preview");

    }

    // -----------------------------
    // Save (optimistic concurrency via version)
    // -----------------------------
    async function saveItem() {
      if (!currentItem) return;
      try {
        msg($("saveMsg"), "Saving...");
        const payload = {
          title: $("title").value.trim(),
          status: $("statusSelect").value,

          story_text: $("story_text").value,
          beschrijving_object: $("beschrijving_object").value.trim(),
          audio_object: $("audio_object").value.trim(),
          klankzuiver_text: $("klankzuiver_text").value,
          klankzuiver_audio_path: $("klankzuiver_letters").value.trim(),

          opdracht1_text: $("opdracht1_text").value,
          opdracht2_text: $("opdracht2_text").value,

          woord_text: $("woord_text").value,

          beschrijving_text: $("beschrijving_text").value,

          story_audio_path: $("story_audio_path").value.trim(),
          opdracht1_audio_path: $("opdracht1_audio_path").value.trim(),
          opdracht2_audio_path: $("opdracht2_audio_path").value.trim(),
          woord_audio_path: $("woord_audio_path").value.trim(),
          beschrijving_audio_path: $("beschrijving_audio_path").value.trim(),
          image1_path: $("image1_path").value.trim(),
          image2_path: $("image2_path").value.trim(),

          text11: $("text11").value,

          page_a_title_letters: $("page_a_title_letters").value,
          page_a_text: $("page_a_text").value,

          page_b_title_letters: $("page_b_title_letters").value,
          page_b_text: $("page_b_text").value,

          page_c_title_letters: $("page_c_title_letters").value,
          page_c_text: $("page_c_text").value,

          handleiding_text: $("handleiding_text").value
        };

        // Only update if version matches what we loaded
        const { data, error } = await sb
          .from("mpop_items")
          .update(payload)
          .eq("id", currentItem.id)
          .eq("version", currentItem.version)
          .select("*")
          .maybeSingle();

        if (error) throw error;

        if (!data) {
          throw new Error("Conflict: the item was updated by someone else. Click Reload item and retry.");
        }

        currentItem = data;
        showEditor(data);
        msg($("saveMsg"), "Saved.");
        await loadItems();
      } catch (e) {
        msg($("saveMsg"), e.message || String(e), false);
      }
    }

    async function reloadItem() {
      if (!currentItem) return;
      await selectItem(currentItem.id);
      msg($("saveMsg"), "Reloaded.");
    }

    // -----------------------------
    // Audio playback (endpoint + path)
    // -----------------------------
    function buildAudioUrl(path) {
      const trimmed = (path || "").trim();
      if (!trimmed) return "";
      if (trimmed.startsWith("http://") || trimmed.startsWith("https://")) {
        return trimmed;
      }
      const base = AUDIO_ENDPOINT.replace(/\/+$/,"");
      const suffix = trimmed.startsWith("/") ? trimmed : "/" + trimmed;
      return base + suffix;
    }

    function buildImageUrl(path) {
      return buildAudioUrl(path);
    }

    function updateImagePreview(inputId, imgId) {
      const img = $(imgId);
      const input = $(inputId);
      const path = (input.value || "").trim() || input.placeholder || "";
      const url = buildImageUrl(path);
      if (!url) {
        img.style.display = "none";
        img.removeAttribute("src");
        return;
      }
      img.src = url;
      img.style.display = "block";
    }

    function setPlayButton(btnId, path) {
      const btn = $(btnId);
      btn.disabled = !path || !path.trim();
      btn.textContent = "Play";
    }

    function wireAudioInput(inputId, btnId) {
      const input = $(inputId);
      input.addEventListener("input", () => setPlayButton(btnId, input.value));
    }

    function toggleAudio(btn, path) {
      const url = buildAudioUrl(path);
      if (!url) throw new Error("No audio path saved for this field yet.");
      let player = audioPlayers.get(url);
      if (!player) {
        player = new Audio(url);
        audioPlayers.set(url, player);
        player.addEventListener("ended", () => { btn.textContent = "Play"; });
      }
      if (!player.paused) {
        player.pause();
        btn.textContent = "Play";
        return;
      }
      btn.textContent = "Pause";
      player.play();
    }

    // -----------------------------
    // Storage helpers (upload + signed links)
    // -----------------------------
    function mustHaveCode() {
      const code = (currentItem?.code || "").trim();
      if (!code) throw new Error("This item has no code. Set code in the database (mpop_items.code).");
      return code;
    }

    async function uploadToBucket(bucket, path, file) {
      const { error } = await sb.storage.from(bucket).upload(path, file, { upsert: true });
      if (error) throw error;
      return path;
    }

    async function signedLink(bucket, path, expiresSeconds = 3600) {
      const { data, error } = await sb.storage.from(bucket).createSignedUrl(path, expiresSeconds);
      if (error) throw error;
      return data.signedUrl;
    }

    async function uploadAndSetField({ bucket, fileInputId, dbField, defaultName }) {
      if (!currentItem) return;
      const code = mustHaveCode();
      const file = $(fileInputId).files?.[0];
      if (!file) throw new Error("Select a file first.");
      const ext = (file.name.split(".").pop() || "").toLowerCase();
      const safeExt = ext ? "." + ext : "";
      const path = `${code}/${defaultName}${safeExt}`;

      await uploadToBucket(bucket, path, file);

      // Update only the path field; still protect with version
      const payload = {};
      payload[dbField] = path;

      const { data, error } = await sb
        .from("mpop_items")
        .update(payload)
        .eq("id", currentItem.id)
        .eq("version", currentItem.version)
        .select("*")
        .maybeSingle();

      if (error) throw error;
      if (!data) throw new Error("Conflict while saving the file path. Reload item and retry.");

      currentItem = data;
      showEditor(data);
      await loadItems();
      return path;
    }

    async function linkForField({ bucket, dbField, outElId }) {
      if (!currentItem) return;
      const path = currentItem[dbField];
      if (!path) throw new Error("No file path saved for this field yet.");
      const url = await signedLink(bucket, path, 3600);
      $(outElId).innerHTML = `<a href="${url}" target="_blank" rel="noreferrer">Open (valid 1 hour)</a>`;
    }

    // -----------------------------
    // Sounds (mpop_sounds)
    // -----------------------------
    async function loadSounds() {
      if (!currentItem) return;
      const { data, error } = await sb
        .from("mpop_sounds")
        .select("id, label, audio_path, sort_order")
        .eq("mpop_item_id", currentItem.id)
        .order("sort_order", { ascending: true });

      if (error) {
        msg($("soundsMsg"), error.message, false);
        return;
      }

      sounds = data || [];
      renderSounds();
        msg($("soundsMsg"), `Loaded ${sounds.length} sound(s).`);
    }

    function renderSounds() {
      const host = $("soundsList");
      host.innerHTML = "";

      if (!sounds.length) {
        const d = document.createElement("div");
        d.className = "muted";
        d.textContent = "No sounds yet.";
        host.appendChild(d);
        return;
      }

      for (const s of sounds) {
        const wrap = document.createElement("div");
        wrap.className = "card";
        wrap.style.padding = "10px";
        wrap.innerHTML = `
          <div class="kpi">
            <div class="pill">Label: <span class="ok mono">${escapeHtml(s.label || "")}</span></div>
            <div class="pill">Order: <span class="ok mono">${escapeHtml(String(s.sort_order ?? 0))}</span></div>
          </div>
          <label style="margin-top:8px;">Audio path (audio_path)</label>
          <div class="inlineRow">
            <input value="${escapeHtml(s.audio_path || "")}" readonly />
            <button data-id="${s.id}" class="btnSoundPlay" ${s.audio_path ? "" : "disabled"}>Play</button>
          </div>
        `;
        host.appendChild(wrap);
      }

      for (const btn of document.querySelectorAll(".btnSoundPlay")) {
        btn.onclick = async () => {
          try {
            const id = btn.getAttribute("data-id");
            const sound = sounds.find(x => x.id === id);
            if (!sound?.audio_path) throw new Error("No audio_path.");
            toggleAudio(btn, sound.audio_path);
          } catch (e) {
            msg($("soundsMsg"), e.message || String(e), false);
          }
        };
      }
    }

    // -----------------------------
    // Wire up buttons
    // -----------------------------
    $("btnSignIn").onclick = signIn;
    $("btnSignUp").onclick = signUp;

    $("btnSignOut").onclick = signOut;
    $("btnRefresh").onclick = () => loadItems();

    $("search").addEventListener("input", async () => {
      // re-render from last loaded list by reloading quickly:
      // simplest: just reload items; if you prefer client-side filtering only, store items list.
      await loadItems();
    });

    $("btnSave").onclick = saveItem;
    $("btnReload").onclick = reloadItem;

    $("btnPlayStoryAudio").onclick = () => {
      try { toggleAudio($("btnPlayStoryAudio"), $("story_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayAudioObject").onclick = () => {
      try { toggleAudio($("btnPlayAudioObject"), $("audio_object").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayKlankzuiverAudio").onclick = () => {
      try { toggleAudio($("btnPlayKlankzuiverAudio"), $("klankzuiver_letters").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht1Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht1Audio"), $("opdracht1_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayOpdracht2Audio").onclick = () => {
      try { toggleAudio($("btnPlayOpdracht2Audio"), $("opdracht2_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayWoordAudio").onclick = () => {
      try { toggleAudio($("btnPlayWoordAudio"), $("woord_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };
    $("btnPlayBeschrijvingAudio").onclick = () => {
      try { toggleAudio($("btnPlayBeschrijvingAudio"), $("beschrijving_audio_path").value); }
      catch(e){ msg($("saveMsg"), e.message || String(e), false); }
    };

    wireAudioInput("story_audio_path", "btnPlayStoryAudio");
    wireAudioInput("audio_object", "btnPlayAudioObject");
    wireAudioInput("klankzuiver_letters", "btnPlayKlankzuiverAudio");
    wireAudioInput("opdracht1_audio_path", "btnPlayOpdracht1Audio");
    wireAudioInput("opdracht2_audio_path", "btnPlayOpdracht2Audio");
    wireAudioInput("woord_audio_path", "btnPlayWoordAudio");
    wireAudioInput("beschrijving_audio_path", "btnPlayBeschrijvingAudio");
    $("image1_path").addEventListener("input", () => updateImagePreview("image1_path", "image1_preview"));
    $("image2_path").addEventListener("input", () => updateImagePreview("image2_path", "image2_preview"));

    // Upload buttons -> update db path fields

    // Link buttons (signed URLs)

    // Sounds
    // no add/refresh buttons in UI; keep loadSounds for selection changes

    // -----------------------------
    // Boot: restore from localStorage (optional convenience)
    // -----------------------------
    window.addEventListener("load", async () => {
      // optional: remember url/key locally
      const savedUrl = localStorage.getItem("mpop_sb_url");
      const savedKey = localStorage.getItem("mpop_sb_anon");
      if (savedUrl) $("sbUrl").value = savedUrl;
      if (savedKey) $("sbAnon").value = savedKey;

      // save on change
      $("sbUrl").addEventListener("change", () => localStorage.setItem("mpop_sb_url", $("sbUrl").value.trim()));
      $("sbAnon").addEventListener("change", () => localStorage.setItem("mpop_sb_anon", $("sbAnon").value.trim()));

      // if user already has a session, refresh UI
      try {
        ensureClient();
        if (!authListenerBound) {
          sb.auth.onAuthStateChange((_event, session) => refreshAuthUI(session));
          authListenerBound = true;
        }
        await refreshAuthUI();
      } catch (_) {
        // no client yet (missing url/key) - ignore
      }
    });
  </script>
</body>
</html>
